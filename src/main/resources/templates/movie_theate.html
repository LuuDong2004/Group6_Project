<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Movies</title>
	    <link rel="stylesheet" th:href="@{/web/assets/css/style-starter.css}">
    <link rel="stylesheet" th:href="@{/web/assets/css/movies.css}">
	<link href="//fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,600&display=swap"
		rel="stylesheet">
</head>

<body>
	<!-- header -->
	<header id="site-header" class="w3l-header fixed-top">
		<!--/nav-->
		<nav class="navbar navbar-expand-lg navbar-light fill px-lg-0 py-0 px-3">
			<div class="container">
				<h1><a class="navbar-brand" href="index.html"><span class="fa fa-play icon-log"
																	aria-hidden="true"></span>
							MyShowz </a></h1>
				<!-- if logo is image enable this   
							<a class="navbar-brand" href="#index.html">
								<img src="image-path" alt="Your logo" title="Your logo" style="height:35px;" />
							</a> -->
				<button class="navbar-toggler collapsed" type="button" data-toggle="collapse"
					data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
					aria-label="Toggle navigation">
					<!-- <span class="navbar-toggler-icon"></span> -->
					<span class="fa icon-expand fa-bars"></span>
					<span class="fa icon-close fa-times"></span>
				</button>

				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="navbar-nav ml-auto">
						<li class="nav-item">
							<a class="nav-link" th:href="@{/}">Home</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" th:href="@{/movies}">Movies</a>
						</li>
						<li class="nav-item active">
							<a class="nav-link" th:href="@{/movie_theater}">Movie Theater</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" th:href="@{/contact}">Contact</a>
						</li>
					</ul>

					<!--/search-right-->
					<!--/search-right-->
					<div class="Login_SignUp" id="login"
						style="font-size: 2rem ; display: inline-block; position: relative;">
						<!-- <li class="nav-item"> -->
						<a class="nav-link" th:href="@{/login}"><i class="fa fa-user-circle-o"></i></a>
						<!-- </li> -->
					</div>

				</div>
				<!-- toggle switch for light and dark theme -->
				<div class="mobile-position">
					<nav class="navigation">
						<div class="theme-switch-wrapper">
							<label class="theme-switch" for="checkbox">
								<input type="checkbox" id="checkbox">
								<div class="mode-container">
									<i class="gg-sun"></i>
									<i class="gg-moon"></i>
								</div>
							</label>
						</div>
					</nav>
				</div>
			</div>
		</nav>
	</header>
    <main style="margin-top: 120px;">
        <style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}
body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}
main {
    flex: 1 0 auto;
    display: flex;
    flex-direction: column;
}
#cinema-flex-container {
    display: flex;
    flex: 1 1 auto;
    min-height: 0;
    height: 100%;
}
#cinema-list {
    flex: 1;
    max-width: 350px;
    overflow-y: auto;
    border-right: 1px solid var(--theme-bg) !important;
    padding: 16px;
    background: var(--theme-bg) !important;    
    height: 100%;
    min-height: 0;
}
#cinema-list div {
    margin-bottom: 18px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}
#cinema-list b {
    color: #007bff;
    cursor: pointer;
}
#map {
    width: 100%;
    height: 100%;
    min-height: 0;
}
#find-cinema-btn {
    margin: 16px 0 0 0;
    display: inline-block;
    z-index: 10;
    position: relative;
    padding: 10px 24px;
    font-size: 1.1rem;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    cursor: pointer;
    transition: background 0.2s;
}
#find-cinema-btn:hover {
    background: #0056b3;
}
@media (max-width: 900px) {
    #cinema-flex-container { flex-direction: column; height: auto; }
    #cinema-list { max-width: 100%; border-right: none; border-bottom: 1px solid #eee; }
    #map { min-height: 250px; }
}
</style>
        <div id="cinema-flex-container">
            <!-- Cột trái: Danh sách rạp -->
            <div id="cinema-list">
                <h3>Gợi ý rạp gần bạn</h3>
                <button id="find-cinema-btn" onclick="showNearestCinemas()">Tìm rạp gần tôi</button>
                <!-- Danh sách rạp sẽ được JS render vào đây -->
            </div>
            <!-- Cột phải: Google Map -->
            <div style="flex: 3;">
                <div id="map"></div>
            </div>
        </div>
    </main>

    <script>
    let map;
    let markers = [];
    let lastUserLat = null, lastUserLng = null;
    let directionsService, directionsRenderer;

    function haversine(lat1, lng1, lat2, lng2) {
        const R = 6371; // km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function showNearestCinemas() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                lastUserLat = lat;
                lastUserLng = lng;
                fetch(`/cinema/nearest/search?lat=${lat}&lng=${lng}`)
                    .then(res => res.json())
                    .then(data => {
                        let html = '';
                        data.forEach(cinema => {
                            const distance = haversine(lat, lng, cinema.latitude, cinema.longitude).toFixed(2);
                            html += `<div>
                                <b style='cursor:pointer;color:#007bff' onclick=\"window.open('https://www.google.com/maps/dir/?api=1&origin=${lat},${lng}&destination=${cinema.latitude},${cinema.longitude}','_blank')\">${cinema.name}</b><br>
                                <span>Khoảng cách: ${distance} km</span><br>
                                <a href=\"https://www.google.com/maps/dir/?api=1&origin=${lat},${lng}&destination=${cinema.latitude},${cinema.longitude}\" target=\"_blank\">Xem trên Google Maps</a> |
                                <a href=\"#\" onclick=\"showDirectionOnMap(${lat},${lng},${cinema.latitude},${cinema.longitude});return false;\">Chỉ đường</a>
                            </div><hr>`;
                        });
                        document.getElementById('cinema-list').innerHTML = html;
                        showMap(lat, lng, data);
                    });
            }, function() {
                alert("Không thể lấy vị trí. Hãy bật định vị!");
            });
        } else {
            alert("Trình duyệt không hỗ trợ định vị.");
        }
    }

    function showDirectionOnMap(userLat, userLng, destLat, destLng) {
        if (!directionsService) directionsService = new google.maps.DirectionsService();
        if (!directionsRenderer) {
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
        }
        const request = {
            origin: { lat: userLat, lng: userLng },
            destination: { lat: destLat, lng: destLng },
            travelMode: 'DRIVING'
        };
        directionsService.route(request, function(result, status) {
            if (status == 'OK') {
                directionsRenderer.setDirections(result);
            } else {
                alert('Không tìm được đường đi!');
            }
        });
    }

    function showMap(userLat, userLng, cinemas) {
        if (!map) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: userLat, lng: userLng },
                zoom: 13
            });
        } else {
            map.setCenter({ lat: userLat, lng: userLng });
        }

        // Xóa directions route cũ nếu có
        if (typeof directionsRenderer !== 'undefined' && directionsRenderer) {
            directionsRenderer.setMap(null);
            directionsRenderer = null;
        }

        // Xóa marker cũ
        markers.forEach(marker => marker.setMap(null));
        markers = [];

        // Marker vị trí người dùng
        const userMarker = new google.maps.Marker({
            position: { lat: userLat, lng: userLng },
            map: map,
            title: "Vị trí của bạn",
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        });
        markers.push(userMarker);

        // Marker các rạp
        cinemas.forEach(cinema => {
            const marker = new google.maps.Marker({
                position: { lat: cinema.latitude, lng: cinema.longitude },
                map: map,
                title: cinema.name
            });
            const infoWindow = new google.maps.InfoWindow({
                content: `<b>${cinema.name}</b><br>Địa chỉ: ${cinema.address}<br>
                <a href="https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${cinema.latitude},${cinema.longitude}" target="_blank">Chỉ đường</a>`
            });
            marker.addListener('click', function() {
                infoWindow.open(map, marker);
            });
            markers.push(marker);
        });
    }
    </script>
    <!-- Thay YOUR_API_KEY bằng Google Maps API Key của bạn. Đăng ký miễn phí tại https://console.cloud.google.com/apis/credentials -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGUA7CFmlf1BwXpX0BRKaSDTvc0WFTFyw"></script>
    <script th:src="@{/web/assets/js/theme-change.js}"></script>
    </body>
    </html>