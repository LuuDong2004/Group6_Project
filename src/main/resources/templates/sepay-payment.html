<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán Sepay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .payment-container { max-width: 800px; margin: 2rem auto; }
        .qr-container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .bank-info { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
        .countdown { font-size: 1.2rem; color: #dc3545; font-weight: bold; }
        .status-indicator { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .status-pending { background-color: #ffc107; }
        .status-success { background-color: #28a745; }
        .status-failed { background-color: #dc3545; }
        .copy-btn { cursor: pointer; color: #0d6efd; }
        .copy-btn:hover { color: #0a58ca; }
    </style>
</head>
<body>
    <div class="container payment-container">
        <div class="qr-container">
            <h2 class="text-center mb-4">
                <i class="fas fa-qrcode me-2"></i>Thanh toán qua Sepay QR
            </h2>

            <!-- Payment Status -->
            <div id="payment-status" class="alert alert-warning text-center mb-4">
                <span id="status-indicator" class="status-indicator status-pending"></span>
                <span id="status-text">Đang chờ thanh toán...</span>
            </div>

            <!-- Countdown Timer -->
            <div class="text-center mb-4">
                <p class="mb-2">Thời gian còn lại:</p>
                <div class="countdown" id="countdown">15:00</div>
            </div>

            <!-- QR Code -->
            <div class="text-center mb-4">
                <img id="sepay-qr" th:src="${qrCodeBase64 != null and #strings.length(qrCodeBase64) > 0 ? qrCodeBase64 : qrCodeUrl}" alt="Sepay QR Code" class="img-fluid" style="max-width: 300px;">
            </div>

            <!-- Thông tin giao dịch -->
            <div class="bank-info">
                <h5 class="mb-3">Thông tin giao dịch</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Mã booking:</strong> <span th:text="${bookingId}"></span></p>
                        <p><strong>Mã merchant:</strong> <span th:text="${merchantCode}"></span></p>
                    </div>
                </div>
            </div>

            <!-- Manual Confirmation Button -->
            <div class="text-center mt-4">
                <button class="btn btn-danger" onclick="cancelPayment()">
                    <i class="fas fa-times-circle me-2"></i>Hủy thanh toán
                </button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Get transaction reference and expiry time from server
        const transactionRef = /*[[${transactionRef}]]*/ '';
        const expiryTime = new Date(/*[[${expiryTime}]]*/ '');
        let countdownInterval = setInterval(updateCountdown, 1000);
        let checkInterval = setInterval(() => checkPaymentStatus(), 5000);

        function updateCountdown() {
            try {
                const now = new Date();
                const diff = expiryTime - now;
                if (diff <= 0) {
                    clearInterval(countdownInterval);
                    clearInterval(checkInterval);
                    document.getElementById('countdown').textContent = '00:00';
                    updatePaymentStatus('failed', 'Hết thời gian thanh toán!');
                    return;
                }
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                document.getElementById('countdown').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } catch (error) {
                console.error('Error updating countdown:', error);
                clearInterval(countdownInterval);
                clearInterval(checkInterval);
                updatePaymentStatus('failed', 'Lỗi đồng hồ đếm ngược!');
            }
        }

        function checkPaymentStatus(showAlert = true) {
            if (!transactionRef) {
                console.error('Transaction reference is missing');
                return;
            }
            fetch(`/payment/sepay/check-status?transactionId=${encodeURIComponent(transactionRef)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        if (data.status === 'COMPLETED') {
                            updatePaymentStatus('success', 'Thanh toán thành công!');
                            clearInterval(checkInterval);
                            clearInterval(countdownInterval);
                            setTimeout(() => {
                                const successUrl = `/payment/success?bookingId=${data.bookingId}&transactionId=${encodeURIComponent(transactionRef)}&paymentMethod=sepay&amount=${encodeURIComponent(data.amount)}`;
                                window.location.href = successUrl;
                            }, 2000);
                        } else if (showAlert) {
                            console.log('Payment pending...');
                        }
                    } else if (showAlert) {
                        console.error('Payment check failed:', data.error);
                        alert('Lỗi kiểm tra trạng thái: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error checking payment status:', error);
                    if (showAlert) {
                        alert('Có lỗi xảy ra khi kiểm tra trạng thái. Vui lòng thử lại sau.');
                    }
                });
        }

        function updatePaymentStatus(status, message) {
            try {
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                const statusAlert = document.getElementById('payment-status');
                if (!statusIndicator || !statusText || !statusAlert) {
                    throw new Error('Status elements not found');
                }
                statusIndicator.className = `status-indicator status-${status}`;
                statusText.textContent = message;
                if (status === 'success') {
                    statusAlert.className = 'alert alert-success text-center';
                } else if (status === 'failed') {
                    statusAlert.className = 'alert alert-danger text-center';
                }
            } catch (error) {
                console.error('Error updating payment status:', error);
            }
        }

        function cancelPayment() {
            if (!transactionRef) {
                alert('Lỗi: Không tìm thấy thông tin giao dịch!');
                return;
            }
            if (confirm('Bạn có chắc chắn muốn hủy thanh toán? Giao dịch này sẽ bị hủy và ghế sẽ được giải phóng.')) {
                clearInterval(checkInterval);
                clearInterval(countdownInterval);
                fetch(`/payment/sepay/cancel?transactionId=${encodeURIComponent(transactionRef)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updatePaymentStatus('failed', 'Đã hủy thanh toán thành công!');
                        setTimeout(() => {
                            const cancelUrl = `/payment/failed?message=Đã hủy thanh toán&bookingId=${data.bookingId}`;
                            window.location.href = cancelUrl;
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Lỗi hủy thanh toán');
                    }
                })
                .catch(error => {
                    console.error('Error cancelling payment:', error);
                    alert('Có lỗi xảy ra khi hủy thanh toán. Vui lòng thử lại sau.');
                });
            }
        }
    </script>
    <script>
    // Tự động hủy thanh toán nếu người dùng thoát trang khi chưa thanh toán thành công
    window.addEventListener('beforeunload', function (e) {
        const statusText = document.getElementById('status-text');
        if (statusText && statusText.textContent.includes('chờ thanh toán')) {
            fetch('/payment/sepay/cancel?transactionId=' + encodeURIComponent(transactionRef), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                keepalive: true
            });
        }
    });
    </script>
</body>
</html> 