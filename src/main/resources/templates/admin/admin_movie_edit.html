<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CinemaAdmin - Chỉnh Sửa Phim</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* CSS cho Admin Dashboard */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        /* Tailwind bg-slate-50 */
        color: #334155;
        /* Tailwind slate-700 for default text */
      }

      /* CSS cho Form thêm/sửa phim */
      .form-section {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .form-section .card-header {
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        background: linear-gradient(
          135deg,
          #6366f1 0%,
          #8b5cf6 100%
        ) !important;
        /* Gradient from indigo to purple */
        color: white;
        /* Ensure text is white on gradient */
      }

      .upload-area {
        border: 2px dashed #e2e8f0;
        /* Tailwind slate-200 */
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.2s ease;
        background-color: #f8fafc;
        /* Light background for upload area */
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: #6366f1;
        /* Tailwind indigo-500 */
        background-color: #f0f9ff;
        /* Lighter blue on hover */
      }

      .upload-area .fa-cloud-upload-alt {
        color: #94a3b8;
        /* Tailwind slate-400 */
        margin-bottom: 0.5rem;
      }

      .upload-area h6 {
        font-weight: 600;
        color: #334155;
        /* Tailwind slate-700 */
        margin-bottom: 0.25rem;
      }

      .upload-area p {
        font-size: 0.875rem;
        color: #64748b;
        /* Tailwind slate-500 */
      }

      .upload-area p .text-primary {
        color: #6366f1 !important;
        /* Tailwind indigo-500 */
        font-weight: 500;
      }

      .upload-area small {
        font-size: 0.75rem;
        color: #94a3b8;
        /* Tailwind slate-400 */
      }

      #imagePreview img {
        max-width: 100%;
        /* Ensure preview image is responsive */
        max-height: 200px;
        /* Adjust max height as needed */
        border: 1px solid #e2e8f0;
        /* Border for the preview image */
        border-radius: 4px;
        object-fit: cover; /* Ensure image covers the area well */
      }

      #removeImageBtn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }

      /* Styling for selectable tags in the form */
      .selectable-tag-form {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        margin: 0.25rem;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
        background-color: #f8fafc;
        color: #475569;
      }

      .selectable-tag-form:hover {
        border-color: #cbd5e1;
        background-color: #f1f5f9;
      }

      .selectable-tag-form.selected {
        background-color: #6366f1;
        color: white;
        border-color: #6366f1;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
      }

      /* CSS để hiển thị genre và format tags theo hàng ngang */
      #genreContainerForm,
      #formatContainerForm {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #genreContainerForm > div,
      #formatContainerForm > div {
        display: inline-block;
      }

      /* Success message styling */
      .success-message {
        background-color: #d1fae5;
        color: #065f46;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #10b981;
        margin-bottom: 1.5rem;
      }

      /* Error message for genres */
      #genreError {
        color: #ef4444; /* Tailwind red-500 */
        font-size: 0.875rem;
        margin-top: 0.5rem;
      }

      /* General form control styling improvements */
      .form-label.fw-semibold {
        color: #334155;
        margin-bottom: 0.5rem;
      }

      /* CSS cho label khi field required không được nhập */
      .form-label.required-error {
        color: #ef4444 !important; /* Tailwind red-500 */
        font-weight: 600;
      }

      .form-control,
      .form-select {
        border-radius: 0.375rem;
        border-color: #cbd5e1;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
      }

      .input-group-text {
        background-color: #f1f5f9;
        border-color: #cbd5e1;
        color: #64748b;
      }

      /* Styling for form action buttons */
      .form-actions {
        padding-top: 1.5rem;
        margin-top: 1.5rem;
        border-top: 1px solid #e2e8f0;
      }

      .form-actions .btn {
        min-width: 120px;
        font-weight: 500;
      }

      .btn-primary {
        background-color: #6366f1;
        border-color: #6366f1;
      }

      .btn-primary:hover {
        background-color: #4f46e5;
        border-color: #4f46e5;
      }

      .btn-outline-danger {
        color: #ef4444;
        border-color: #ef4444;
      }

      .btn-outline-danger:hover {
        color: white;
        background-color: #ef4444;
        border-color: #ef4444;
      }

      .btn-outline-secondary {
        color: #64748b;
        border-color: #cbd5e1;
      }

      .btn-outline-secondary:hover {
        background-color: #f1f5f9;
        color: #475569;
        border-color: #cbd5e1;
      }

      .sidebar-custom {
        width: 260px;
        background: linear-gradient(180deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        z-index: 1000;
      }

      .sidebar-custom.collapsed {
        width: 80px;
      }

      .sidebar-custom.collapsed .sidebar-header h5,
      .sidebar-custom.collapsed .sidebar-header small,
      .sidebar-custom.collapsed .sidebar-menu span,
      .sidebar-custom.collapsed .mt-auto .text-white,
      .sidebar-custom.collapsed .mt-auto small {
        display: none;
      }

      .sidebar-custom.collapsed .sidebar-menu .menu-item {
        justify-content: center;
      }

      .sidebar-custom.collapsed .sidebar-header .bg-white.rounded-circle.p-2.me-3 {
        margin-right: 0 !important;
      }

      .sidebar-custom.collapsed .mt-auto img.rounded-circle.me-3 {
        margin-right: 0 !important;
      }

      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-header .fa-film {
        color: #6366f1;
      }

      .sidebar-menu {
        flex-grow: 1;
        padding-top: 1rem;
      }

      .menu-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: background-color 0.2s ease, color 0.2s ease;
      }

      .menu-item:hover,
      .menu-item.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        border-left: 3px solid white;
        padding-left: calc(1.5rem - 3px);
      }

      .sidebar-custom.collapsed .menu-item:hover,
      .sidebar-custom.collapsed .menu-item.active {
        border-left: none;
        padding-left: 1.5rem;
      }

      .sidebar-custom.collapsed .menu-item.active {
        background-color: #4f46e5;
      }

      .menu-item i {
        width: 20px;
        margin-right: 0.75rem;
        text-align: center;
      }

      .sidebar-custom.collapsed .menu-item i {
        margin-right: 0;
        font-size: 1.25rem;
      }

      .main-content-wrapper {
        margin-left: 260px;
        transition: margin-left 0.3s ease;
        padding-top: 70px; /* Height of header-custom */
      }

      .main-content-wrapper.expanded {
        margin-left: 80px;
      }

      .header-custom {
        position: fixed;
        top: 0;
        left: 260px;
        right: 0;
        height: 70px;
        background-color: white;
        border-bottom: 1px solid #e5e7eb; /* Tailwind gray-200 */
        z-index: 999;
        transition: left 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
      }

      .main-content-wrapper.expanded .header-custom {
        left: 80px;
      }

      /* Responsive adjustments */
      @media (max-width: 992px) {
        /* Changed breakpoint to 992px for better consistency with common Bootstrap/admin layouts */
        .sidebar-custom {
          width: 80px;
        }

        .sidebar-custom .sidebar-header h5,
        .sidebar-custom .sidebar-header small,
        .sidebar-custom .sidebar-menu span,
        .sidebar-custom .mt-auto .text-white,
        .sidebar-custom .mt-auto small {
          display: none;
        }

        .sidebar-custom .sidebar-menu .menu-item {
          justify-content: center;
        }
        .sidebar-custom .sidebar-header .bg-white.rounded-circle.p-2.me-3 {
          margin-right: 0 !important;
        }
        .sidebar-custom .mt-auto img.rounded-circle.me-3 {
          margin-right: 0 !important;
        }

        .sidebar-custom .sidebar-menu .menu-item i {
          margin-right: 0;
          font-size: 1.25rem;
        }

        .main-content-wrapper {
          margin-left: 80px;
        }

        .header-custom {
          left: 80px;
        }
      }
      @media (max-width: 768px) {
        .header-custom {
          padding: 0 1rem;
        }
        .header-custom .d-none.d-sm-inline {
          /* Hide user name text on smaller screens */
          display: none !important;
        }
        /* Further adjustments if needed for very small screens */
      }

      /* Autocomplete Multi-Select Styles */
      .autocomplete-container {
        position: relative;
      }

      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
      }

      .autocomplete-item:hover {
        background-color: #f8f9fa;
      }

      .autocomplete-item:last-child {
        border-bottom: none;
      }

      .autocomplete-item.selected {
        background-color: #e3f2fd;
        color: #1976d2;
      }

      .selected-items-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 20px;
      }

      .selected-item-badge {
        display: inline-flex;
        align-items: center;
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 16px;
        font-size: 0.875rem;
        border: 1px solid #bbdefb;
      }

      .selected-item-badge .remove-btn {
        background: none;
        border: none;
        color: #1976d2;
        margin-left: 6px;
        cursor: pointer;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }

      .selected-item-badge .remove-btn:hover {
        background-color: #1976d2;
        color: white;
      }

      .autocomplete-no-results {
        padding: 8px 12px;
        color: #666;
        font-style: italic;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <!-- Sidebar content -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main Content Wrapper -->
    <div class="main-content-wrapper" id="mainContentWrapper">
      <!-- Header -->
      <header class="header-custom shadow-sm">
        <div class="d-flex align-items-center">
          <button class="btn btn-link text-slate-500 me-2" id="sidebarToggle">
            <i class="fas fa-bars fs-5"></i>
            <!-- Changed text color -->
          </button>
          <h4 class="mb-0 fw-semibold text-slate-700" id="main-header-title">
            Chỉnh Sửa Phim
          </h4>
          <!-- Updated Title -->
        </div>

        <div class="d-flex align-items-center">
          <button class="btn btn-link text-slate-500 me-1 position-relative">
            <!-- Changed text color -->
            <i class="fas fa-bell fs-5"></i>
            <span
              class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
              style="
                font-size: 0.5rem;
                width: 10px;
                height: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
              "
            >
              <span class="visually-hidden">Thông báo mới</span>
            </span>
          </button>
          <button class="btn btn-link text-slate-500 me-2">
            <!-- Changed text color -->
            <i class="fas fa-cog fs-5"></i>
          </button>
          <div class="dropdown">
            <a
              href="#"
              class="d-flex align-items-center text-decoration-none dropdown-toggle"
              id="dropdownUser"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <img
                th:src="${userAvatarUrl != null ? userAvatarUrl : 'https://placehold.co/32x32/6366F1/FFFFFF?text=A'}"
                alt="User Avatar"
                width="32"
                height="32"
                class="rounded-circle me-2"
                onerror="this.onerror=null; this.src='https://placehold.co/32x32/6366F1/FFFFFF?text=A';"
              />
              <span
                class="d-none d-sm-inline text-slate-700 fw-medium"
                th:text="${userName != null ? userName : ''}"
                ></span
              >
            </a>
            <ul
              class="dropdown-menu dropdown-menu-end text-small shadow border-0 rounded-lg"
              <!--
              Added
              rounded-lg
              --
            >
              aria-labelledby="dropdownUser">
              <li>
                <a class="dropdown-item py-2" href="#"
                  ><i class="fas fa-user-circle me-2 text-slate-500"></i>Hồ
                  sơ</a
                >
              </li>
              <li>
                <a class="dropdown-item py-2" href="#"
                  ><i class="fas fa-sliders-h me-2 text-slate-500"></i>Cài
                  đặt</a
                >
              </li>
              <li><hr class="dropdown-divider my-1" /></li>
              <li>
                <a class="dropdown-item py-2 text-danger" href="#"
                  ><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a
                >
              </li>
            </ul>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <div class="container-fluid p-3 p-md-4">
        <!-- Adjusted padding -->
        <!-- Assuming movie object is passed from controller -->
        <form
          id="movieForm"
          th:object="${movie}"
          th:action="@{/admin/movies/edit/{id}(id=${movie.id})}"
          method="post"
          enctype="multipart/form-data"
        >
          <!-- Hidden inputs for selected directors and actors -->
          <div id="hiddenInputsContainer"></div>
          <div class="row">
            <div class="col-12">
              <!-- Basic Information Section -->
              <div class="form-section">
                <div class="card-header p-3">
                  <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-info-circle me-2"></i>
                    Thông tin cơ bản
                  </h5>
                </div>
                <div class="card-body p-3 p-md-4">
                  <div class="row">
                    <div class="col-md-12 mb-3">
                      <label class="form-label fw-semibold" for="name"
                        >Tên phim *</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="name"
                        th:field="*{name}"
                        placeholder="Nhập tên phim"
                        required
                      />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label fw-semibold" for="description"
                      >Mô tả *</label
                    >
                    <textarea
                      class="form-control"
                      id="description"
                      th:field="*{description}"
                      rows="3"
                      placeholder="Nhập mô tả và tóm tắt phim"
                      required
                    ></textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-semibold" for="duration"
                        >Thời lượng (phút) *</label
                      >
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="fas fa-clock"></i
                        ></span>
                        <input
                          type="number"
                          class="form-control"
                          id="duration"
                          th:field="*{duration}"
                          placeholder="120"
                          required
                        />
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-semibold" for="rating"
                        >Rating *</label
                      >
                      <select
                        class="form-select"
                        id="rating"
                        th:field="*{ratingId}"
                        required
                      >
                        <option value="">Chọn rating</option>
                        <!-- Load ratings từ database -->
                        <option
                          th:each="rating : ${allRatings}"
                          th:value="${rating.id}"
                          th:text="${rating.code + ' - ' + rating.description}"
                          th:selected="${rating.id == movie.ratingId}"
                        >
                          G - Mọi lứa tuổi
                        </option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-semibold" for="releaseDate"
                        >Ngày phát hành *</label
                      >
                      <!-- Ensure movie.releaseDate is formatted as yyyy-MM-dd or use #dates.format if needed -->
                      <input
                        type="date"
                        class="form-control"
                        id="releaseDate"
                        th:field="*{releaseDate}"
                        required
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Genres Section -->
              <div class="form-section">
                <div class="card-header p-3">
                  <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-tags me-2"></i>
                    Thể loại *
                  </h5>
                </div>
                <div class="card-body p-3 p-md-4">
                  <p class="text-muted mb-2 small">
                    Chọn tất cả thể loại phù hợp cho phim này
                  </p>
                  <div id="genreContainerForm">
                    <!-- Load genres từ database -->
                    <div th:each="genre : ${allGenres}">
                      <input
                        type="checkbox"
                        th:id="'genre_' + ${genre.id}"
                        name="genres"
                        th:value="${genre.id}"
                        class="d-none"
                        th:checked="${movie.genreIds != null && movie.genreIds.contains(genre.id)}"
                      />
                      <label
                        th:for="'genre_' + ${genre.id}"
                        class="selectable-tag-form"
                        th:text="${genre.name}"
                        >Thể loại</label
                      >
                    </div>
                  </div>
                  <div
                    id="genreError"
                    class="text-danger small mt-2"
                    style="display: none"
                  ></div>
                </div>
              </div>

              <!-- Media & Links Section -->
              <div class="form-section">
                <div class="card-header p-3">
                  <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-image me-2"></i>
                    Media & Liên kết
                  </h5>
                </div>
                <div class="card-body p-3 p-md-4">
                  <div class="mb-3">
                    <label class="form-label fw-semibold" for="image"
                      >Poster phim (thay đổi nếu muốn)</label
                    >
                    <div class="upload-area" id="uploadArea">
                      <i class="fas fa-cloud-upload-alt fa-2x"></i>
                      <h6>Kéo & Thả poster vào đây</h6>
                      <p class="mb-1">
                        hoặc <span class="text-primary">chọn tệp</span>
                      </p>
                      <small>PNG, JPG tối đa 5MB. Đề xuất: 300x450px</small>
                      <!-- Removed 'required' for edit form, backend handles if no new image is uploaded -->
                      <input
                        type="file"
                        id="image"
                        name="image"
                        class="d-none"
                        accept="image/png, image/jpeg"
                      />
                    </div>
                    <div
                      id="imagePreview"
                      class="mt-3 text-center position-relative"
                      th:classappend="${movie.image == null || movie.image == ''} ? 'd-none' : ''"
                      style="
                        max-width: 200px;
                        margin-left: auto;
                        margin-right: auto;
                      "
                    >
                      <img
                        id="previewImg"
                        class="img-fluid rounded"
                        alt="Xem trước poster"
                        th:src="${(movie.image != null && movie.image != '') ? movie.image : 'https://placehold.co/300x450/E2E8F0/475569?text=Poster'}"
                        onerror="this.onerror=null; this.src='https://placehold.co/300x450/E2E8F0/475569?text=Poster';"
                      />
                      <button
                        type="button"
                        id="removeImageBtn"
                        class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                        th:classappend="${movie.image == null || movie.image == ''} ? 'd-none' : ''"
                        title="Xóa ảnh"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label fw-semibold" for="trailerUrl"
                      >Link Trailer *</label
                    >
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fab fa-youtube"></i
                      ></span>
                      <input
                        type="url"
                        class="form-control"
                        id="trailerUrl"
                        th:field="*{trailer}"
                        placeholder="https://www.youtube.com/watch?v=..."
                        required
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Additional Information Section -->
              <div class="form-section">
                <div class="card-header p-3">
                  <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-cogs me-2"></i>
                    Thông tin thêm
                  </h5>
                </div>
                <div class="card-body p-3 p-md-4">
                  <!-- Directors Multi-Select -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold" for="directorSearch"
                      >Đạo diễn</label
                    >
                    <div class="autocomplete-container">
                      <div class="input-group">
                        <input
                          type="text"
                          class="form-control"
                          id="directorSearch"
                          placeholder="Tìm kiếm đạo diễn..."
                        />
                        <button
                          type="button"
                          class="btn btn-outline-primary"
                          id="addDirectorBtn"
                        >
                          <i class="fas fa-plus"></i> Thêm
                        </button>
                      </div>
                      <div
                        class="autocomplete-dropdown"
                        id="directorDropdown"
                        style="display: none"
                      >
                        <div
                          th:each="director : ${allDirectors}"
                          class="autocomplete-item"
                          th:data-id="${director.id}"
                          th:data-name="${director.name}"
                          th:text="${director.name}"
                        ></div>
                      </div>
                    </div>
                    <!-- Selected Directors Badges -->
                    <div
                      class="selected-items-container mt-2"
                      id="selectedDirectors"
                    >
                      <!-- Selected director badges will appear here -->
                    </div>
                  </div>

                  <!-- Actors Multi-Select -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold" for="actorSearch"
                      >Diễn viên chính</label
                    >
                    <div class="autocomplete-container">
                      <div class="input-group">
                        <input
                          type="text"
                          class="form-control"
                          id="actorSearch"
                          placeholder="Tìm kiếm diễn viên..."
                        />
                        <button
                          type="button"
                          class="btn btn-outline-primary"
                          id="addActorBtn"
                        >
                          <i class="fas fa-plus"></i> Thêm
                        </button>
                      </div>
                      <div
                        class="autocomplete-dropdown"
                        id="actorDropdown"
                        style="display: none"
                      >
                        <div
                          th:each="actor : ${allActors}"
                          class="autocomplete-item"
                          th:data-id="${actor.id}"
                          th:data-name="${actor.name}"
                          th:text="${actor.name}"
                        ></div>
                      </div>
                    </div>
                    <!-- Selected Actors Badges -->
                    <div
                      class="selected-items-container mt-2"
                      id="selectedActors"
                    >
                      <!-- Selected actor badges will appear here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div
            class="d-flex justify-content-end align-items-center form-actions"
          >
            <button type="button" class="btn btn-outline-secondary me-2">
              <i class="fas fa-save me-2"></i>
              Lưu nháp
            </button>
            <a
              th:href="@{/admin/movies/list}"
              class="btn btn-outline-danger me-2"
            >
              <i class="fas fa-times me-2"></i>
              Hủy
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="fas fa-save me-2"></i>
              <!-- Changed icon and text -->
              Lưu Thay Đổi
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/admin-common.js}"></script>

    <!-- Pass existing directors and actors data to JavaScript -->
    <script th:inline="javascript">
      // Convert existing directors and actors to JavaScript objects
      window.existingDirectors = [];
      window.existingActors = [];
      window.allDirectorsData = /*[[${allDirectors}]]*/ [];
      window.allActorsData = /*[[${allActors}]]*/ [];

      /*<![CDATA[*/
      // Pre-populate directors if they exist
      var movieDirectors = /*[[${movie.directors}]]*/ null;
      var movieActors = /*[[${movie.actors}]]*/ null;
      var allDirectors = /*[[${allDirectors}]]*/ [];
      var allActors = /*[[${allActors}]]*/ [];

      if (movieDirectors && movieDirectors.length > 0) {
        movieDirectors.forEach(function (directorName) {
          // Find director by name in allDirectors
          allDirectors.forEach(function (director) {
            if (director.name === directorName) {
              window.existingDirectors.push({
                id: director.id,
                name: director.name,
              });
            }
          });
        });
      }

      // Pre-populate actors if they exist
      if (movieActors && movieActors.length > 0) {
        movieActors.forEach(function (actorName) {
          // Find actor by name in allActors
          allActors.forEach(function (actor) {
            if (actor.name === actorName) {
              window.existingActors.push({
                id: actor.id,
                name: actor.name,
              });
            }
          });
        });
      }

      console.log("Existing directors:", window.existingDirectors);
      console.log("Existing actors:", window.existingActors);
      /*]]>*/
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Set header title on load
        const headerTitle = document.getElementById("main-header-title");
        if (headerTitle) {
          // This is now static in HTML but can be dynamic if needed
          // headerTitle.textContent = 'Chỉnh Sửa Phim';
        }

        initializeSidebarToggle();
        initializeFileUploadPreview(
          "uploadArea",
          "image",
          "imagePreview",
          "previewImg",
          "removeImageBtn"
        );
        initializeSelectableTagsVisuals();

        // Initialize autocomplete multi-select for directors and actors
        initializeAutocomplete();

        const movieForm = document.getElementById("movieForm");
        if (movieForm) {
          movieForm.addEventListener("submit", function (event) {
            // Chỉ validate genres vì HTML5 sẽ handle required fields
            if (!validateGenres()) {
              event.preventDefault();
              return false;
            }
            // Add a loading state to the submit button
            const submitBtn = document.getElementById("submitBtn");
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML =
                '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang lưu...';
            }
          });
        }

        initializeRequiredFieldValidation();
      });

      // Moved to admin-common.js

      // Moved to admin-common.js

      function initializeSelectableTagsVisuals() {
        document.querySelectorAll(".selectable-tag-form").forEach((label) => {
          const checkboxId = label.getAttribute("for");
          const checkbox = document.getElementById(checkboxId);

          if (checkbox) {
            // Initial state based on 'checked' attribute (set by Thymeleaf)
            if (checkbox.checked) {
              label.classList.add("selected");
            }

            checkbox.addEventListener("change", function () {
              if (this.checked) {
                label.classList.add("selected");
              } else {
                label.classList.remove("selected");
              }
              // Clear genre error if user starts selecting
              const genreErrorDiv = document.getElementById("genreError");
              if (genreErrorDiv) genreErrorDiv.style.display = "none";

              label.style.transform = "scale(0.97)";
              setTimeout(() => {
                label.style.transform = "scale(1)";
              }, 150);
            });

            // Allow clicking label to toggle checkbox (standard behavior, but ensuring event fires for class toggle)
            label.addEventListener("click", function (event) {
              // Checkbox state will toggle automatically due to 'for' attribute.
              // We just need to ensure the 'change' event on checkbox fires if not already.
              // Modern browsers usually handle this well. If not, manually trigger:
              // if (event.target === label) { checkbox.click(); }
            });
          }
        });
      }

      function validateGenres() {
        const genreCheckboxes = document.querySelectorAll(
          'input[name="genres"]'
        );
        const checkedGenres = Array.from(genreCheckboxes).filter(
          (checkbox) => checkbox.checked
        );
        const genreErrorDiv = document.getElementById("genreError");
        const genreSectionHeader = document
          .querySelector("#genreContainerForm")
          .closest(".form-section")
          .querySelector(".card-header h5");

        if (checkedGenres.length === 0) {
          if (genreErrorDiv) {
            genreErrorDiv.textContent =
              "Vui lòng chọn ít nhất một thể loại cho phim!";
            genreErrorDiv.style.display = "block";
          }
          if (genreSectionHeader) {
            // Visual cue for the section
            genreSectionHeader.classList.add("text-danger"); // Temporary highlight
            setTimeout(
              () => genreSectionHeader.classList.remove("text-danger"),
              2000
            );
          }
          document
            .getElementById("genreContainerForm")
            .scrollIntoView({ behavior: "smooth", block: "center" });
          return false;
        } else {
          if (genreErrorDiv) genreErrorDiv.style.display = "none";
          if (genreSectionHeader)
            genreSectionHeader.classList.remove("text-danger");
        }
        return true;
      }

      function initializeRequiredFieldValidation() {
        const requiredFields = document.querySelectorAll(
          "input[required], textarea[required], select[required]"
        );

        requiredFields.forEach((field) => {
          const label = document.querySelector(`label[for="${field.id}"]`);

          function validate() {
            validateRequiredField(field, label);
          }

          field.addEventListener("blur", validate);
          field.addEventListener("input", validate);
          if (field.tagName === "SELECT" || field.type === "date") {
            // date also benefits from change
            field.addEventListener("change", validate);
          }
        });
      }

      // Removed complex validation functions - using HTML5 validation instead

      // Autocomplete Multi-Select Functionality
      function initializeAutocomplete() {
        // Initialize Directors Autocomplete
        initializeAutocompleteForType("director", "selectedDirectors");

        // Initialize Actors Autocomplete
        initializeAutocompleteForType("actor", "selectedActors");

        // Pre-populate existing directors and actors
        prePopulateExistingSelections();
      }

      function initializeAutocompleteForType(type, hiddenInputName) {
        const searchInput = document.getElementById(type + "Search");
        const dropdown = document.getElementById(type + "Dropdown");
        const selectedContainer = document.getElementById(
          type === "director" ? "selectedDirectors" : "selectedActors"
        );
        const addBtn = document.getElementById(
          "add" + type.charAt(0).toUpperCase() + type.slice(1) + "Btn"
        );

        const selectedItems = new Set();
        let filteredItems = [];
        let selectedIndex = -1;

        // Get all items from dropdown
        const allItems = Array.from(
          dropdown.querySelectorAll(".autocomplete-item")
        ).map((item) => ({
          id: parseInt(item.dataset.id),
          name: item.dataset.name,
        }));

        searchInput.addEventListener("input", function () {
          const query = this.value.toLowerCase();
          filteredItems = allItems.filter((item) =>
            item.name.toLowerCase().includes(query)
          );
          selectedIndex = -1;
          updateDropdown();
        });

        searchInput.addEventListener("focus", function () {
          const query = this.value.toLowerCase();
          filteredItems = allItems.filter((item) =>
            item.name.toLowerCase().includes(query)
          );
          selectedIndex = -1;
          updateDropdown();
        });

        searchInput.addEventListener("blur", function () {
          // Delay hiding to allow click events on dropdown items
          setTimeout(() => {
            dropdown.style.display = "none";
          }, 200);
        });

        searchInput.addEventListener("keydown", function (e) {
          if (dropdown.style.display === "none") return;

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              selectedIndex = Math.min(
                selectedIndex + 1,
                filteredItems.length - 1
              );
              updateDropdownSelection();
              break;
            case "ArrowUp":
              e.preventDefault();
              selectedIndex = Math.max(selectedIndex - 1, -1);
              updateDropdownSelection();
              break;
            case "Enter":
              e.preventDefault();
              if (selectedIndex >= 0 && filteredItems[selectedIndex]) {
                addSelectedItem(filteredItems[selectedIndex]);
              }
              break;
            case "Escape":
              dropdown.style.display = "none";
              break;
          }
        });

        addBtn.addEventListener("click", function () {
          const query = searchInput.value.trim();
          if (query) {
            // Check if exact match exists
            const exactMatch = allItems.find(
              (item) => item.name.toLowerCase() === query.toLowerCase()
            );
            if (exactMatch) {
              addSelectedItem(exactMatch);
            } else {
              // Create new item (this would need backend support)
              console.log("Would create new " + type + ": " + query);
            }
          }
        });

        function updateDropdown() {
          dropdown.innerHTML = "";

          if (filteredItems.length === 0) {
            const noResults = document.createElement("div");
            noResults.className = "autocomplete-no-results";
            noResults.textContent = "Không tìm thấy kết quả";
            dropdown.appendChild(noResults);
          } else {
            filteredItems.forEach((item, index) => {
              const itemElement = document.createElement("div");
              itemElement.className = "autocomplete-item";
              itemElement.textContent = item.name;
              itemElement.addEventListener("click", () =>
                addSelectedItem(item)
              );
              dropdown.appendChild(itemElement);
            });
          }

          dropdown.style.display = "block";
        }

        function updateDropdownSelection() {
          const items = dropdown.querySelectorAll(
            ".autocomplete-item:not(.autocomplete-no-results)"
          );
          items.forEach((item, index) => {
            item.classList.toggle("selected", index === selectedIndex);
          });
        }

        function addSelectedItem(item) {
          if (selectedItems.has(item.id)) return;

          selectedItems.add(item.id);

          // Create badge
          const badge = document.createElement("div");
          badge.className = "selected-item-badge";
          badge.innerHTML = `
            ${item.name}
            <button type="button" class="remove-btn" data-id="${item.id}">
              <i class="fas fa-times"></i>
            </button>
          `;

          // Add remove functionality
          badge
            .querySelector(".remove-btn")
            .addEventListener("click", function () {
              selectedItems.delete(item.id);
              badge.remove();
              updateHiddenInputs();
            });

          selectedContainer.appendChild(badge);

          // Clear search and hide dropdown
          searchInput.value = "";
          dropdown.style.display = "none";
          selectedIndex = -1;

          updateHiddenInputs();
        }

        function updateHiddenInputs() {
          const container = document.getElementById("hiddenInputsContainer");

          // Remove existing hidden inputs for this type
          const existingInputs = container.querySelectorAll(
            `input[name="selected${
              type.charAt(0).toUpperCase() + type.slice(1)
            }s"]`
          );
          existingInputs.forEach((input) => input.remove());

          // Add new hidden inputs
          selectedItems.forEach((id) => {
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = `selected${
              type.charAt(0).toUpperCase() + type.slice(1)
            }s`;
            hiddenInput.value = id;
            container.appendChild(hiddenInput);
          });
        }

        // Expose functions for pre-population
        window[`add${type.charAt(0).toUpperCase() + type.slice(1)}Selection`] =
          addSelectedItem;
      }

      function prePopulateExistingSelections() {
        // This function will be called to pre-populate existing directors and actors
        // The data will be passed from the server-side template

        // Pre-populate directors
        if (window.existingDirectors) {
          window.existingDirectors.forEach((director) => {
            if (window.addDirectorSelection) {
              window.addDirectorSelection(director);
            }
          });
        }

        // Pre-populate actors
        if (window.existingActors) {
          window.existingActors.forEach((actor) => {
            if (window.addActorSelection) {
              window.addActorSelection(actor);
            }
          });
        }
      }
    </script>
  </body>
</html>

