<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinemaAdmin - Chỉnh sửa Phòng Chiếu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Sử dụng CSS chung cho admin -->
    <link rel="stylesheet" th:href="@{/css/admin2-common.css}" />
    <style>
        * {
            font-family: "Inter", sans-serif;
        }
        .sidebar-custom {
            width: 260px;
            background: linear-gradient(
              180deg,
              #4f46e5 0%,
              #7c3aed 100%
            );
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar.collapsed .sidebar-header h5,
        .sidebar.collapsed .sidebar-header small,
        .sidebar.collapsed .sidebar-menu span,
        .sidebar.collapsed .mt-auto .text-white,
        .sidebar.collapsed .mt-auto small {
            display: none;
        }
        .sidebar.collapsed .sidebar-menu .menu-item {
            justify-content: center;
        }
        .sidebar.collapsed .sidebar-header .bg-white.rounded-circle.p-2.me-3 {
            margin-right: 0 !important;
        }
        .sidebar.collapsed .mt-auto .bg-white.rounded-circle.p-2.me-3 {
            margin-right: 0 !important;
        }
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar-header .fa-film {
            color: #6366f1;
        }
        .sidebar-menu {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding-top: 1rem;
        }
        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .menu-item:hover,
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 3px solid white;
            padding-left: calc(1.5rem - 3px);
        }
        .sidebar.collapsed .menu-item:hover,
        .sidebar.collapsed .menu-item.active {
            border-left: none;
            padding-left: 1.5rem;
        }
        .sidebar.collapsed .menu-item.active {
            background-color: #4f46e5;
        }
        .menu-item i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }
        .sidebar.collapsed .menu-item i {
            margin-right: 0;
            font-size: 1.25rem;
        }
        .main-content-wrapper {
            margin-left: 260px;
            transition: margin-left 0.3s ease;
            padding-top: 70px;
        }
        .main-content-wrapper.expanded {
            margin-left: 80px;
        }
        .header-custom {
            position: fixed;
            top: 0;
            left: 260px;
            right: 0;
            height: 70px;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            z-index: 999;
            transition: left 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
        }
        .main-content-wrapper.expanded .header-custom {
            left: 80px;
        }
        .page-content { padding: 2rem; }
        .container { max-width: none; padding: 0; }
        .edit-room-container { display: flex; gap: 32px; margin-top: 20px; }
        .seat-map-panel { flex: 1.5; background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 32px; display: flex; flex-direction: column; align-items: center; }
        .seat-map-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        .seat-map { display: grid; gap: 8px; margin-bottom: 16px; }
        .seat { width: 32px; height: 32px; border-radius: 6px; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: border 0.2s, background 0.2s; }
        .seat-popular { border-color: #22c55e; background: #f0fdf4; }
        .seat-standard { border-color: #ef4444; background: #fef2f2; }
        .seat-vip { border-color: #8b5cf6; background: #faf5ff; }
        .seat-label { font-size: 12px; color: #64748b; margin-bottom: 8px; }
        .edit-form-panel { flex: 1; background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 32px; }
        .form-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        .form-group { margin-bottom: 18px; }
        .form-label { font-weight: 500; margin-bottom: 6px; display: block; }
        .form-control, .form-select { border-radius: 6px; }
        .error-message { color: #ef4444; font-size: 14px; margin-bottom: 8px; }
        .seat-legend { display: flex; gap: 16px; margin-bottom: 16px; }
        .seat-legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .seat-legend .seat { width: 20px; height: 20px; }
        .seat-legend .seat { width: 20px; height: 20px; }
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }
            .sidebar .sidebar-header h5,
            .sidebar .sidebar-header small,
            .sidebar .sidebar-menu span,
            .sidebar .mt-auto .text-white,
            .sidebar .mt-auto small {
                display: none;
            }
            .sidebar .sidebar-menu .menu-item {
                justify-content: center;
            }
            .sidebar .sidebar-menu .menu-item i {
                margin-right: 0;
                font-size: 1.25rem;
            }
            .main-content-wrapper {
                margin-left: 80px;
            }
            .header-custom {
                left: 80px;
                padding: 0 1rem;
            }
            .header-custom .flex-grow-1 {
                display: none;
            }
            .edit-room-container { flex-direction: column; }
            .seat-map-panel, .edit-form-panel { width: 100%; }
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/sidebar :: sidebar}"></div>
<div class="main-content-wrapper" id="mainContentWrapper">
    <header class="header-custom shadow-sm">
        <div class="d-flex align-items-center">
            <button class="btn btn-link text-secondary me-2" id="sidebarToggle">
                <i class="fas fa-bars fs-5"></i>
            </button>
            <h4 class="mb-0 fw-semibold text-gray-700" id="main-header-title">Quản lý Phòng Chiếu</h4>
            </div>
        <div class="d-flex align-items-center">
            <button class="btn btn-link text-secondary me-1 position-relative">
                <i class="fas fa-bell fs-5"></i>
                <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
                      style="font-size: 0.5rem; width:10px; height:10px; display:flex; align-items:center; justify-content:center;">
                    <span class="visually-hidden">Thông báo mới</span>
                </span>
            </button>
            <button class="btn btn-link text-secondary me-2">
                <i class="fas fa-cog fs-5"></i>
            </button>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser"
                   data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="d-none d-sm-inline text-gray-700 fw-medium"></span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end text-small shadow border-0" aria-labelledby="dropdownUser">
                    <li><a class="dropdown-item" href="/profile"><i class="fas fa-user-circle me-2 text-muted"></i>Hồ sơ</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-sliders-h me-2 text-muted"></i>Cài đặt</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="/admin/logout"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                </ul>
            </div>
        </div>
    </header>
    <div class="container-fluid p-4">
    
    <!-- Thông báo cảnh báo khi không thể chỉnh sửa -->
    <div th:if="${cannotEdit}" class="alert alert-warning mt-3" role="alert">
        <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Không thể chỉnh sửa phòng chiếu!</h5>
        <p class="mb-0">Phòng chiếu này đang có suất chiếu đang hoạt động. Bạn chỉ có thể chỉnh sửa sau khi:</p>
        <ul class="mb-0 mt-2">
            <li>Hết thời gian chiếu của tất cả suất chiếu</li>
            <li>Hoặc gỡ bỏ các suất chiếu đang hoạt động</li>
        </ul>
    </div>
    
    <!-- Danh sách suất chiếu đang hoạt động -->
    <div th:if="${activeSchedules != null and !activeSchedules.empty}" class="alert alert-info mt-3" role="alert">
        <h6 class="alert-heading"><i class="fas fa-calendar-alt"></i> Danh sách suất chiếu đang hoạt động:</h6>
        <div class="table-responsive">
            <table class="table table-sm table-borderless mb-0">
                <thead>
                    <tr>
                        <th>Phim</th>
                        <th>Ngày chiếu</th>
                        <th>Giờ bắt đầu</th>
                        <th>Giờ kết thúc</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="schedule : ${activeSchedules}">
                        <td th:text="${schedule.movie != null ? schedule.movie.name : 'N/A'}"></td>
                        <td th:text="${#dates.format(schedule.screeningDate, 'dd/MM/yyyy')}"></td>
                        <td th:text="${schedule.startTime}"></td>
                        <td th:text="${schedule.endTime}"></td>
                        <td th:text="${schedule.status == 'ACTIVE' ? 'Hoạt động' : schedule.status == 'ENDED' ? 'Không hoạt động' :schedule.status == 'MAINTENANCE' ? 'Bảo trì' : ''}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="edit-room-container">
        <!-- Sơ đồ ghế động -->
        <div class="seat-map-panel">
            <div class="seat-map-title">Sơ đồ ghế</div>
            <div class="seat-label">
                <span id="seatMapInfo"></span>
            </div>
            <div class="seat-legend">
                <div class="seat-legend-item"><div class="seat seat-popular"></div> Popular</div>
                <div class="seat-legend-item"><div class="seat seat-standard"></div> Standard</div>
                <div class="seat-legend-item"><div class="seat seat-vip"></div> VIP</div>
            </div>
            <div id="seatMap" class="seat-map"></div>
        </div>
        <!-- Form chỉnh sửa -->
        <div class="edit-form-panel">
            <div class="form-title">Chỉnh sửa thông tin phòng chiếu</div>
            <form th:action="@{/admin/screening-rooms/edit/{id}(id=${screeningRoom.id})}" method="post" th:object="${screeningRoom}" onsubmit="return validateRowsAndSeats();">
                <input type="hidden" th:field="*{branch.id}" />
                <div class="form-group">
                    <label class="form-label">Tên phòng chiếu</label>
                    <input type="text" class="form-control" th:field="*{name}" required th:readonly="${cannotEdit}" th:disabled="${cannotEdit}" >
                    <div th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="text-danger"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Chọn hàng ghế:</label>
                    <input type="number" class="form-control" id="rows" th:field="*{rows}" min="2" required th:readonly="${cannotEdit}" th:disabled="${cannotEdit}" >
                </div>
                <div class="form-group">
                    <label class="form-label">Số ghế mỗi hàng:</label>
                    <input type="number" class="form-control" id="seatsPerRow" th:field="*{seatsPerRow}" min="2" required th:readonly="${cannotEdit}" th:disabled="${cannotEdit}" >
                </div>
                <div class="form-group">
                    <label class="form-label">Số lượng ghế</label>
                    <input type="number" class="form-control" id="capacity" th:field="*{capacity}" readonly th:readonly="${cannotEdit}" th:disabled="${cannotEdit}" >
                </div>
                <div id="rowsSeatsError" class="error-message"></div>
                <div class="form-group">
                    <div class="form-label">*Mặc định kiểu: 25% ghế đầu là Popular, 50% ghế giữa là Standard, 25% ghế cuối là VIP</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Type:</label>
                    <div>
                        <label><input type="radio" th:field="*{type}" value="2D" required th:disabled="${cannotEdit}"> 2D</label>
                        <label class="ms-3"><input type="radio" th:field="*{type}" value="3D" th:disabled="${cannotEdit}"> 3D</label>
                        <label class="ms-3"><input type="radio" th:field="*{type}" value="4D" th:disabled="${cannotEdit}"> 4D</label>
                        <label class="ms-3"><input type="radio" th:field="*{type}" value="5D" th:disabled="${cannotEdit}"> 5D</label>
                        <label class="ms-3"><input type="radio" th:field="*{type}" value="IMAX" th:disabled="${cannotEdit}"> IMAX</label>

                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Trạng thái:</label>
                    <select class="form-select" th:field="*{status}" required th:disabled="${cannotEdit}" >
                        <option value="ACTIVE">Hoạt động</option>
                        <option value="INACTIVE">Không hoạt động</option>
                        <option value="MAINTENANCE">Bảo trì</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-control" th:field="*{description}" rows="3" th:readonly="${cannotEdit}" th:disabled="${cannotEdit}" ></textarea>
                </div>
                <div class="d-flex gap-2 mt-4">
                    <a th:href="@{/admin/screening-rooms/branch/{id}(id=${screeningRoom.branch.id})}" class="btn btn-secondary">Hủy</a>
                    <button type="submit" class="btn btn-primary" th:if="${cannotEdit == null or !cannotEdit}">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="https://kit.fontawesome.com/4e7f7e6e8b.js" crossorigin="anonymous"></script>
<script>
// Validate số hàng ghế và số ghế mỗi hàng
function validateRowsAndSeats() {
    const rows = parseInt(document.getElementById('rows').value);
    const seats = parseInt(document.getElementById('seatsPerRow').value);
    let error = '';
    if (rows !== seats) {
        error = 'Số hàng phải bằng số cột (hàng bằng cột)';
    }
    document.getElementById('rowsSeatsError').innerText = error;
    renderSeatMap();
    return error === '';
}
document.getElementById('rows').addEventListener('input', validateRowsAndSeats);
document.getElementById('seatsPerRow').addEventListener('input', validateRowsAndSeats);

// Render sơ đồ ghế động
function renderSeatMap() {
    const rowsInput = document.getElementById('rows');
    const seatsInput = document.getElementById('seatsPerRow');
    const seatMap = document.getElementById('seatMap');
    
    if (!rowsInput || !seatsInput || !seatMap) {
        console.log('Các element cần thiết chưa sẵn sàng');
        return;
    }
    
    const rows = parseInt(rowsInput.value);
    const seats = parseInt(seatsInput.value);
    
    console.log('renderSeatMap called with rows:', rows, 'seats:', seats);
    seatMap.innerHTML = '';
    
    if (isNaN(rows) || isNaN(seats) || rows < 2 || seats < 2) {
        console.log('Giá trị không hợp lệ hoặc nhỏ hơn 2');
        return;
    }
    seatMap.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    seatMap.style.gridTemplateColumns = `repeat(${seats}, 1fr)`;

    // Quy tắc: popular ở đầu, standard ở giữa, vip ở cuối
    const popularRows = Math.floor(rows * 0.25);
    const vipRows = Math.floor(rows * 0.25);
    const standardStart = popularRows;
    const standardEnd = rows - vipRows;

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < seats; c++) {
            let seatType = '';
            
            if (r < popularRows) {
                seatType = 'seat-popular'; // Popular
            } else if (r >= standardStart && r < standardEnd) {
                seatType = 'seat-standard'; // Standard
            } else {
                seatType = 'seat-vip'; // VIP
            }
            
            const seatDiv = document.createElement('div');
            seatDiv.className = 'seat ' + seatType;
            
            seatMap.appendChild(seatDiv);
        }
    }
    document.getElementById('seatMapInfo').innerText = `Chọn hàng ghế: ${rows}, Số ghế mỗi hàng: ${seats}`;
}

function updateCapacity() {
    const rows = parseInt(document.getElementById('rows').value);
    const seats = parseInt(document.getElementById('seatsPerRow').value);
    const capacityInput = document.getElementById('capacity');
    if (!isNaN(rows) && !isNaN(seats) && rows > 0 && seats > 0) {
        capacityInput.value = rows * seats;
    } else {
        capacityInput.value = '';
    }
}
document.getElementById('rows').addEventListener('input', updateCapacity);
document.getElementById('seatsPerRow').addEventListener('input', updateCapacity);
window.onload = function() {
    validateRowsAndSeats();
    updateCapacity();
};

// Đảm bảo render seat map sau khi DOM đã được populate đầy đủ
document.addEventListener('DOMContentLoaded', function() {
    // Delay nhỏ để đảm bảo Thymeleaf đã populate values
    setTimeout(function() {
        renderSeatMap();
        updateCapacity();
    }, 100);
});
</script>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/admin-common.js}"></script>
<script>
    // Khởi tạo các chức năng cần thiết
    document.addEventListener('DOMContentLoaded', function () {
        initializeSidebarToggle();
    });
</script>
</body>
</html>