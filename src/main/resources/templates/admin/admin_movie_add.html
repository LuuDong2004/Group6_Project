<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CinemaAdmin - Thêm Phim Mới</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/assets/css/admin_movie_add.css" />
  </head>

  <body>
    <!-- Sidebar content -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div class="main-content-wrapper" id="mainContentWrapper">
      <header class="header-custom shadow-sm">
        <div class="d-flex align-items-center">
          <button class="btn btn-link text-secondary me-2" id="sidebarToggle">
            <i class="fas fa-bars fs-5"></i>
          </button>
          <h4 class="mb-0 fw-semibold text-gray-700" id="main-header-title">
            Thêm Phim Mới
          </h4>
        </div>

        <div class="d-flex align-items-center">
          <button class="btn btn-link text-secondary me-1 position-relative">
            <i class="fas fa-bell fs-5"></i>
            <span
              class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
              style="
                font-size: 0.5rem;
                width: 10px;
                height: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
              "
            >
              <span class="visually-hidden">Thông báo mới</span>
            </span>
          </button>
          <button class="btn btn-link text-secondary me-2">
            <i class="fas fa-cog fs-5"></i>
          </button>
          <div class="dropdown">
            <a
              href="#"
              class="d-flex align-items-center text-decoration-none dropdown-toggle"
              id="dropdownUser"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <img
                src="https://via.placeholder.com/32"
                alt="User Avatar"
                width="32"
                height="32"
                class="rounded-circle me-2"
              />
              <span class="d-none d-sm-inline text-gray-700 fw-medium"
                >Admin User</span
              >
            </a>
            <ul
              class="dropdown-menu dropdown-menu-end text-small shadow border-0"
              aria-labelledby="dropdownUser"
            >
              <li>
                <a class="dropdown-item" href="#"
                  ><i class="fas fa-user-circle me-2 text-muted"></i>Hồ sơ</a
                >
              </li>
              <li>
                <a class="dropdown-item" href="#"
                  ><i class="fas fa-sliders-h me-2 text-muted"></i>Cài đặt</a
                >
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>
              <li>
                <a class="dropdown-item text-danger" href="#"
                  ><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a
                >
              </li>
            </ul>
          </div>
        </div>
      </header>

      <div class="container-fluid p-4">
        <div id="addMovieFormView" class="container py-4">
          <header class="mb-4"></header>
          <form
            id="movieForm"
            th:action="@{/admin/movies/add}"
            method="post"
            enctype="multipart/form-data"
          >
            <!-- Hidden inputs for selected directors and actors -->
            <div id="hiddenInputsContainer"></div>
            <div class="row">
              <div class="col-12">
                <div class="form-section">
                  <div class="card-header p-3">
                    <h5 class="mb-0 fw-semibold">
                      <i class="fas fa-info-circle me-2"></i>
                      Thông tin cơ bản
                    </h5>
                  </div>
                  <div class="card-body p-3 p-md-4">
                    <div class="row">
                      <div class="col-md-12 mb-3">
                        <label class="form-label fw-semibold" for="name"
                          >Tên phim *</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="name"
                          name="name"
                          placeholder="Nhập tên phim"
                          required
                        />
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold" for="description"
                        >Mô tả *</label
                      >
                      <textarea
                        class="form-control"
                        id="description"
                        name="description"
                        rows="3"
                        placeholder="Nhập mô tả và tóm tắt phim"
                        required
                      ></textarea>
                    </div>
                    <div class="row">
                      <div class="col-md-4 mb-3">
                        <label
                          class="form-label fw-semibold"
                          for="duration"
                          type="number"
                          id="duration"
                          name="duration"
                          min="1"
                          required
                          oninput="this.value = !!this.value && Math.abs(this.value) >= 1 ? Math.abs(this.value) : null"
                          >Thời lượng (phút) *</label
                        >
                        <div class="input-group">
                          <span class="input-group-text"
                            ><i class="fas fa-clock"></i
                          ></span>
                          <input
                            type="number"
                            class="form-control"
                            id="duration"
                            name="duration"
                            placeholder="120"
                            required
                          />
                        </div>
                      </div>
                      <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold" for="rating"
                          >Rating *</label
                        >
                        <select
                          class="form-select"
                          id="rating"
                          name="ratingId"
                          required
                        >
                          <option value="">Chọn rating</option>
                          <option
                            th:each="rating : ${allRatings}"
                            th:value="${rating.id}"
                            th:text="${rating.code + ' - ' + rating.description}"
                          ></option>
                        </select>
                      </div>
                      <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold" for="releaseDate"
                          >Ngày phát hành *</label
                        >
                        <input
                          type="date"
                          class="form-control"
                          id="releaseDate"
                          name="releaseDate"
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-section">
                  <div class="card-header p-3">
                    <h5 class="mb-0 fw-semibold">
                      <i class="fas fa-tags me-2"></i>
                      Thể loại *
                    </h5>
                  </div>
                  <div class="card-body p-3 p-md-4">
                    <p class="text-muted mb-2 small">
                      Chọn tất cả thể loại phù hợp cho phim này
                    </p>
                    <div id="genreContainerForm">
                      <div th:each="genre : ${allGenres}">
                        <input
                          type="checkbox"
                          th:id="'genre_' + ${genre.id}"
                          name="genres"
                          th:value="${genre.id}"
                          class="d-none"
                        />
                        <label
                          th:for="'genre_' + ${genre.id}"
                          class="selectable-tag-form"
                          th:text="${genre.name}"
                        ></label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-section">
                  <div class="card-header p-3">
                    <h5 class="mb-0 fw-semibold">
                      <i class="fas fa-image me-2"></i>
                      Media & Liên kết
                    </h5>
                  </div>
                  <div class="card-body p-3 p-md-4">
                    <div class="mb-3">
                      <label class="form-label fw-semibold" for="image"
                        >Poster phim *</label
                      >
                      <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt fa-2x"></i>
                        <h6>Kéo & Thả poster vào đây</h6>
                        <p class="mb-1">
                          hoặc <span class="text-primary">chọn tệp</span>
                        </p>
                        <small>PNG, JPG tối đa 5MB. Đề xuất: 300x450px</small>
                        <input
                          type="file"
                          id="image"
                          name="image"
                          class="d-none"
                          accept="image/png, image/jpeg"
                          required
                        />
                      </div>
                      <div
                        id="imagePreview"
                        class="mt-3 d-none text-center position-relative"
                        style="
                          max-width: 200px;
                          margin-left: auto;
                          margin-right: auto;
                        "
                      >
                        <img
                          id="previewImg"
                          class="img-fluid rounded"
                          alt="Xem trước poster"
                        />
                        <button
                          type="button"
                          id="removeImageBtn"
                          class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 d-none"
                          title="Xóa ảnh"
                        >
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold" for="trailerUrl"
                        >Link Trailer</label
                      >
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="fab fa-youtube"></i
                        ></span>
                        <input
                          type="url"
                          class="form-control"
                          id="trailerUrl"
                          name="trailerUrl"
                          placeholder="https://www.youtube.com/watch?v=..."
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-section">
                  <div class="card-header p-3">
                    <h5 class="mb-0 fw-semibold">
                      <i class="fas fa-cogs me-2"></i>
                      Thông tin thêm
                    </h5>
                  </div>
                  <div class="card-body p-3 p-md-4">
                    <!-- Directors Multi-Select -->
                    <div class="mb-3">
                      <label class="form-label fw-semibold" for="directorSearch"
                        >Đạo diễn</label
                      >
                      <div class="autocomplete-container">
                        <div class="input-group">
                          <input
                            type="text"
                            class="form-control"
                            id="directorSearch"
                            placeholder="Tìm kiếm đạo diễn..."
                          />
                          <button
                            type="button"
                            class="btn btn-outline-primary"
                            id="addDirectorBtn"
                          >
                            <i class="fas fa-plus"></i> Thêm
                          </button>
                        </div>
                        <div
                          class="autocomplete-dropdown"
                          id="directorDropdown"
                          style="display: none"
                        >
                          <div
                            th:each="director : ${allDirectors}"
                            class="autocomplete-item"
                            th:data-id="${director.id}"
                            th:data-name="${director.name}"
                            th:text="${director.name}"
                          ></div>
                        </div>
                      </div>
                      <!-- Selected Directors Badges -->
                      <div
                        class="selected-items-container mt-2"
                        id="selectedDirectors"
                      >
                        <!-- Selected director badges will appear here -->
                      </div>
                    </div>

                    <!-- Actors Multi-Select -->
                    <div class="mb-3">
                      <label class="form-label fw-semibold" for="actorSearch"
                        >Diễn viên chính</label
                      >
                      <div class="autocomplete-container">
                        <div class="input-group">
                          <input
                            type="text"
                            class="form-control"
                            id="actorSearch"
                            placeholder="Tìm kiếm diễn viên..."
                          />
                          <button
                            type="button"
                            class="btn btn-outline-primary"
                            id="addActorBtn"
                          >
                            <i class="fas fa-plus"></i> Thêm
                          </button>
                        </div>
                        <div
                          class="autocomplete-dropdown"
                          id="actorDropdown"
                          style="display: none"
                        >
                          <div
                            th:each="actor : ${allActors}"
                            class="autocomplete-item"
                            th:data-id="${actor.id}"
                            th:data-name="${actor.name}"
                            th:text="${actor.name}"
                          ></div>
                        </div>
                      </div>
                      <!-- Selected Actors Badges -->
                      <div
                        class="selected-items-container mt-2"
                        id="selectedActors"
                      >
                        <!-- Selected actor badges will appear here -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div
              class="d-flex justify-content-end align-items-center form-actions"
            >
              <button type="button" class="btn btn-outline-secondary me-2">
                <i class="fas fa-save me-2"></i>
                Lưu nháp
              </button>
              <a
                th:href="@{/admin/movies/list}"
                class="btn btn-outline-danger me-2"
              >
                <i class="fas fa-times me-2"></i>
                Hủy
              </a>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-plus me-2"></i>
                Thêm Phim
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/admin-common.js}"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Set header title on load
        const headerTitle = document.getElementById("main-header-title");
        if (headerTitle) {
          headerTitle.textContent = "Thêm Phim Mới";
        }

        // Initialize sidebar behavior
        initializeSidebarToggle();

        // Initialize file upload (image preview)
        initializeFileUploadPreview(
          "uploadArea",
          "image",
          "imagePreview",
          "previewImg",
          "removeImageBtn"
        );

        // Initialize selectable tags (genres and formats) visual state
        initializeSelectableTagsVisuals();

        // Initialize autocomplete multi-select for directors and actors
        initializeAutocomplete();

        // Simplified form validation using HTML5 + custom genre validation
        const movieForm = document.getElementById("movieForm");
        if (movieForm) {
          movieForm.addEventListener("submit", function (event) {
            // Chỉ validate genres vì HTML5 sẽ handle required fields
            if (!validateGenres()) {
              event.preventDefault();
              return false;
            }
          });
        }

        // HTML5 validation sẽ handle required fields tự động
      });

      // Moved to admin-common.js

      // Moved to admin-common.js

      // New function to handle visual state of selectable tags (checkboxes)
      function initializeSelectableTagsVisuals() {
        document.querySelectorAll(".selectable-tag-form").forEach((label) => {
          const checkboxId = label.getAttribute("for");
          const checkbox = document.getElementById(checkboxId);

          if (checkbox) {
            // Set initial state based on checkbox checked status
            if (checkbox.checked) {
              label.classList.add("selected");
            }

            // Add event listener to toggle 'selected' class when checkbox changes
            checkbox.addEventListener("change", function () {
              if (this.checked) {
                label.classList.add("selected");
              } else {
                label.classList.remove("selected");
              }
              // Optional: Add animation on visual change
              label.style.transform = "scale(0.97)";
              setTimeout(() => {
                label.style.transform = "scale(1)";
              }, 150);
            });

            // Also listen to label click to ensure visual update if checkbox is clicked directly
            label.addEventListener("click", function (event) {
              // Prevent default label behavior from double-toggling if checkbox click also fires
              event.preventDefault();
              checkbox.checked = !checkbox.checked; // Manually toggle checkbox
              checkbox.dispatchEvent(new Event("change")); // Trigger change event to update label class
            });
          }
        });
      }

      // Function to validate genres (at least one must be selected)
      function validateGenres() {
        const genreCheckboxes = document.querySelectorAll(
          'input[name="genres"]'
        );
        const checkedGenres = Array.from(genreCheckboxes).filter(
          (checkbox) => checkbox.checked
        );

        if (checkedGenres.length === 0) {
          alert("Vui lòng chọn ít nhất một thể loại cho phim!");
          return false;
        }
        return true;
      }

      // Removed complex validation functions - using HTML5 validation instead

      // Autocomplete Multi-Select Functionality
      function initializeAutocomplete() {
        // Initialize Directors Autocomplete
        initializeAutocompleteForType("director", "selectedDirectors");

        // Initialize Actors Autocomplete
        initializeAutocompleteForType("actor", "selectedActors");
      }

      function initializeAutocompleteForType(type, hiddenInputName) {
        const searchInput = document.getElementById(type + "Search");
        const dropdown = document.getElementById(type + "Dropdown");
        const selectedContainer = document.getElementById(
          type === "director" ? "selectedDirectors" : "selectedActors"
        );
        const addBtn = document.getElementById(
          "add" + type.charAt(0).toUpperCase() + type.slice(1) + "Btn"
        );

        let selectedItems = new Set();
        let filteredItems = [];
        let selectedIndex = -1;

        // Get all items from dropdown
        const allItems = Array.from(
          dropdown.querySelectorAll(".autocomplete-item")
        ).map((item) => ({
          id: parseInt(item.dataset.id),
          name: item.dataset.name,
        }));

        // Search functionality
        searchInput.addEventListener("input", function () {
          const query = this.value.toLowerCase().trim();

          if (query === "") {
            dropdown.style.display = "none";
            return;
          }

          // Filter items based on search query
          filteredItems = allItems.filter(
            (item) =>
              item.name.toLowerCase().includes(query) &&
              !selectedItems.has(item.id)
          );

          updateDropdown();
          selectedIndex = -1;
        });

        // Keyboard navigation
        searchInput.addEventListener("keydown", function (e) {
          if (dropdown.style.display === "none") return;

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              selectedIndex = Math.min(
                selectedIndex + 1,
                filteredItems.length - 1
              );
              updateDropdownSelection();
              break;
            case "ArrowUp":
              e.preventDefault();
              selectedIndex = Math.max(selectedIndex - 1, -1);
              updateDropdownSelection();
              break;
            case "Enter":
              e.preventDefault();
              if (selectedIndex >= 0 && filteredItems[selectedIndex]) {
                addSelectedItem(filteredItems[selectedIndex]);
              }
              break;
            case "Escape":
              dropdown.style.display = "none";
              selectedIndex = -1;
              break;
          }
        });

        // Add button functionality
        addBtn.addEventListener("click", function () {
          const query = searchInput.value.trim();
          if (query && selectedIndex >= 0 && filteredItems[selectedIndex]) {
            addSelectedItem(filteredItems[selectedIndex]);
          }
        });

        // Click outside to close dropdown
        document.addEventListener("click", function (e) {
          if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = "none";
            selectedIndex = -1;
          }
        });

        function updateDropdown() {
          dropdown.innerHTML = "";

          if (filteredItems.length === 0) {
            const noResults = document.createElement("div");
            noResults.className = "autocomplete-no-results";
            noResults.textContent = "Không tìm thấy kết quả";
            dropdown.appendChild(noResults);
          } else {
            filteredItems.forEach((item, index) => {
              const itemElement = document.createElement("div");
              itemElement.className = "autocomplete-item";
              itemElement.textContent = item.name;
              itemElement.addEventListener("click", () =>
                addSelectedItem(item)
              );
              dropdown.appendChild(itemElement);
            });
          }

          dropdown.style.display = "block";
        }

        function updateDropdownSelection() {
          const items = dropdown.querySelectorAll(
            ".autocomplete-item:not(.autocomplete-no-results)"
          );
          items.forEach((item, index) => {
            item.classList.toggle("selected", index === selectedIndex);
          });
        }

        function addSelectedItem(item) {
          if (selectedItems.has(item.id)) return;

          selectedItems.add(item.id);

          // Create badge
          const badge = document.createElement("div");
          badge.className = "selected-item-badge";
          badge.innerHTML = `
            ${item.name}
            <button type="button" class="remove-btn" data-id="${item.id}">
              <i class="fas fa-times"></i>
            </button>
          `;

          // Add remove functionality
          badge
            .querySelector(".remove-btn")
            .addEventListener("click", function () {
              selectedItems.delete(item.id);
              badge.remove();
              updateHiddenInputs();
            });

          selectedContainer.appendChild(badge);

          // Clear search and hide dropdown
          searchInput.value = "";
          dropdown.style.display = "none";
          selectedIndex = -1;

          updateHiddenInputs();
        }

        function updateHiddenInputs() {
          const container = document.getElementById("hiddenInputsContainer");

          // Remove existing hidden inputs for this type
          container
            .querySelectorAll(`input[name="${hiddenInputName}"]`)
            .forEach((input) => input.remove());

          // Add new hidden inputs
          selectedItems.forEach((id) => {
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = hiddenInputName;
            hiddenInput.value = id;
            container.appendChild(hiddenInput);
          });
        }
      }
    </script>
  </body>
</html>

