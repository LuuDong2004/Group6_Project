<!DOCTYPE html>
<html lang="zxx">
  <html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
      <!-- Required meta tags -->
      <meta charset="utf-8" />
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no"
      />
      <title>Phim</title>
      <link rel="stylesheet" th:href="@{/assets/css/style-starter.css}" />

      <!--    	<link rel="stylesheet" href="assets/css/style-starter.css">-->
      <!--    <link href="//fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,600&display=swap"-->
      <!--          rel="stylesheet">-->
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
      />
    </head>

    <body>
      <div th:replace="~{fragments/header :: header}"></div>
      <!--/breadcrumbs -->
      <div class="w3l-breadcrumbs">
        <nav id="breadcrumbs" class="breadcrumbs">
          <div class="container page-wrapper">
            <a href="/">Trang chủ</a> »
            <span class="breadcrumb_last" aria-current="page">phim</span>
          </div>
        </nav>
      </div>
      <!--/movies -->
      <!--grids-sec1-->
      <!--Đông-topMovie-->
      <!--<section class="w3l-grids">-->
      <!--    <div class="grids-main py-4">-->
      <!--        <div class="container py-lg-4">-->
      <!--            <div class="headerhny-title">-->
      <!--                <h3 class="hny-title">Top Movies</h3>-->
      <!--            </div>-->
      <!--            <div class="owl-four owl-carousel owl-theme">-->
      <!--                &lt;!&ndash; Loop qua danh sách các bộ phim &ndash;&gt;-->
      <!--                <div th:each="movie : ${topMovies}" class="item vhny-grid">-->
      <!--                    <div class="box16">-->
      <!--                        <a>-->
      <!--                            <figure>-->
      <!--                                <img class="img-fluid" th:src="${movie.image}">-->
      <!--                            </figure>-->
      <!--                            <div class="box-content">-->
      <!--                                <h3 class="title" th:text="${movie.name}"></h3>-->
      <!--                                <h4>-->
      <!--                                    <span class="post">-->
      <!--                                        <span class="fa fa-clock-o"></span>-->
      <!--                                        <span th:text="${movie.duration + ' mins'}"></span>-->
      <!--                                    </span>-->
      <!--                                    <span class="post fa fa-heart text-right"></span>-->
      <!--                                </h4>-->
      <!--                            </div>-->
      <!--                            <span class="fa fa-play video-icon" aria-hidden="true"></span>-->
      <!--                        </a>-->
      <!--                    </div>-->
      <!--                </div>-->
      <!--            </div>-->
      <!--        </div>-->
      <!--    </div>-->
      <!--</section>-->

      <section class="w3l-grids">
        <div class="grids-main py-5">
          <div class="container py-lg-4">
            <div class="headerhny-title">
              <h3 class="hny-title">PHIM NỔI BẬT</h3>
            </div>
            <div class="row">
              <div
                th:each="movie : ${topMovies}"
                class="col-lg-3 col-md-4 col-sm-6 mb-4"
              >
                <div class="box16 mb-0">
                  <figure>
                    <img
                      th:src="${movie.image} + '?t=' + ${timestamp}"
                      class="img-fluid"
                      alt="Movie Image"
                    />
                  </figure>
                  <div class="box-content">
                    <h3 th:text="${movie.name}" class="title"></h3>
                    <h4>
                      <span th:text="${movie.duration + ' Phút'}" class="post">
                        <span class="fa fa-clock-o"></span>
                      </span>
                    </h4>
                    <p class="movie-info">
                      <small
                        th:text="${movie.ratingDisplay != null ? movie.ratingDisplay : 'N/A'}"
                        class="text-muted"
                        >Rating</small
                      ><br />
                      <small
                        th:text="${movie.genreDisplay != null ? movie.genreDisplay : 'N/A'}"
                        class="text-muted"
                        >Genre</small
                      >
                    </p>
                    <div class="action-buttons">
                      <a
                        th:href="@{/schedule/movie/{id}/date(id=${movie.id},date=${#dates.format(#dates.createNow(),'yyyy-MM-dd')})}"
                        class="btn btn-success mb-2"
                        >Đặt vé</a
                      >
                      <a
                        th:href="@{/movie/view/{id}(id=${movie.id})}"
                        class="btn btn-danger"
                        >Chi tiết</a
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- Đông_Tất cả phim-->
      <!-- Phần danh sách toàn bộ phim -->
      <section class="w3l-grids">
        <div class="grids-main py-5">
          <div class="container py-lg-4">
            <div class="headerhny-title">
              <div class="w3l-title-grids">
                <div class="headerhny-left">
                  <h3 class="hny-title">Danh sách phim</h3>
                </div>
              </div>
            </div>
            <!-- Thanh lọc ở đầu trang -->
            <div class="row mb-4">
              <div class="col-md-3">
                <input
                  type="text"
                  id="searchInput"
                  class="form-control"
                  placeholder="Tìm phim..."
                />
              </div>
              <div class="col-md-3">
                <select id="genreSelect" class="form-control">
                  <option value="">Tất cả thể loại</option>
                  <!-- Option động sẽ được render bằng JS -->
                </select>
              </div>
              <div class="col-md-2">
                <select id="sortSelect" class="form-control">
                  <option value="rating">Đánh giá cao</option>
                  <option value="az">Tên A-Z</option>
                </select>
              </div>
              <div class="col-md-2">
                <button id="filterBtn" class="btn btn-primary w-100">
                  Lọc
                </button>
              </div>
            </div>
            <!-- Danh sách phim mặc định -->
            <div id="movie-list" class="row">
              <div
                th:each="movie : ${Movies}"
                class="col-lg-3 col-md-4 col-sm-6 mb-4"
              >
                <div class="box16 mb-0">
                  <figure>
                    <img
                      th:src="${movie.image} + '?t=' + ${timestamp}"
                      class="img-fluid"
                      alt="Movie Image"
                    />
                  </figure>
                  <div class="box-content">
                    <h3 th:text="${movie.name}" class="title"></h3>
                    <h4>
                      <span th:text="${movie.duration + ' Phút'}" class="post">
                        <span class="fa fa-clock-o"></span>
                      </span>
                    </h4>
                    <p class="movie-info">
                      <small
                        th:text="${movie.ratingDisplay != null ? movie.ratingDisplay : 'N/A'}"
                        class="text-muted"
                        >Rating</small
                      ><br />
                      <small
                        th:text="${movie.genreDisplay != null ? movie.genreDisplay : 'N/A'}"
                        class="text-muted"
                        >Genre</small
                      >
                    </p>
                    <div class="action-buttons">
                      <a
                        th:href="@{/schedule/movie/{id}/date(id=${movie.id},date=${#dates.format(#dates.createNow(),'yyyy-MM-dd')})}"
                        class="btn btn-success mb-2"
                        >Đặt vé</a
                      >
                      <a
                        th:href="@{/movie/view/{id}(id=${movie.id})}"
                        class="btn btn-danger"
                        >Chi tiết</a
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div
              id="filtered-movie-list"
              class="row"
              style="display: none"
            ></div>
            <!-- Nút More -->
            <div id="pagination" class="mt-3 text-center"></div>
          </div>
        </div>
      </section>
      <!-- GỢI Ý CHO BẠN -->
      <section class="w3l-grids">
        <div class="grids-main py-5">
          <div class="container py-lg-4">
            <div class="headerhny-title">
              <h3 class="hny-title">GỢI Ý CHO BẠN</h3>
            </div>
            <div class="row">
              <div
                th:each="movie : ${recommendedMovies}"
                class="col-lg-3 col-md-4 col-sm-6 mb-4"
              >
                <div class="box16 mb-0">
                  <figure>
                    <img
                      th:src="${movie.image} + '?t=' + ${timestamp}"
                      class="img-fluid"
                      th:alt="${movie.name}"
                    />
                  </figure>
                  <div class="box-content">
                    <h3 th:text="${movie.name}" class="title"></h3>
                    <h4>
                      <span th:text="${movie.duration + ' Phút'}" class="post">
                        <span class="fa fa-clock-o"></span>
                      </span>
                    </h4>
                    <div class="action-buttons">
                      <a
                        th:href="@{/schedule/movie/{id}/date(id=${movie.id},date=${#dates.format(#dates.createNow(),'yyyy-MM-dd')})}"
                        class="btn btn-success mb-2"
                        >Đặt vé</a
                      >
                      <a
                        th:href="@{/movie/view/{id}(id=${movie.id})}"
                        class="btn btn-danger"
                        >Chi tiết</a
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- Phần danh sách phim theo thể loại -->
      <section class="w3l-albums py-5" id="projects">
        <div class="container py-lg-4">
          <div class="row">
            <div class="col-lg-12 mx-auto">
              <!-- Tabs lựa chọn thể loại -->
              <div id="parentHorizontalTab">
                <ul class="resp-tabs-list hor_1">
                  <!-- Tab cho Kid Movies -->
                  <li th:classappend="${selected == 'Kid'} ? 'resp-tab-active'">
                    <a
                      th:href="@{/movie/view(genre='Kid')}"
                      style="color: black"
                      >Phim thiếu nhi</a
                    >
                  </li>
                  <!-- Tab cho Love Movies -->
                  <li
                    th:classappend="${selected == 'Love'} ? 'resp-tab-active'"
                  >
                    <a
                      th:href="@{/movie/view(genre='Love')}"
                      style="color: black"
                      >Phim tình cảm</a
                    >
                  </li>
                  <!-- Tab cho Action Movies -->
                  <li
                    th:classappend="${selected == 'Action'} ? 'resp-tab-active'"
                  >
                    <a
                      th:href="@{/movie/view(genre='Action')}"
                      style="color: black"
                      >Phim hành động</a
                    >
                  </li>
                  <div class="clear"></div>
                </ul>
                <div class="resp-tabs-container hor_1">
                  <div class="albums-content">
                    <div class="row">
                      <!-- Hiển thị danh sách phim theo thể loại -->
                      <div
                        th:each="movie : ${filteredMovies}"
                        class="col-lg-4 new-relise-gd mt-lg-0 mt-0"
                      >
                        <div class="slider-info">
                          <div class="img-circle">
                            <a th:href="@{/movie/view/{id}(id=${movie.id})}">
                              <img
                                th:src="${movie.image} + '?t=' + ${timestamp}"
                                class="img-fluid"
                              />
                              <div class="overlay-icon">
                                <span
                                  class="fa fa-play video-icon"
                                  aria-hidden="true"
                                ></span>
                              </div>
                            </a>
                          </div>
                          <div class="message">
                            <p th:text="${movie.language}"></p>
                            <a
                              th:text="${movie.name}"
                              class="author-book-title"
                              th:href="@{/movie/view/{id}(id=${movie.id})}"
                            ></a>
                            <br />
                            <span class="post">
                              <span
                                th:text="${movie.duration}"
                                class="fa fa-clock-o"
                              ></span>
                              <span class="post fa fa-heart text-right"></span>
                            </span>
                          </div>
                        </div>
                      </div>
                      <!-- Không hiển thị thông báo "Không tìm thấy phim nào" -->
                    </div>
                  </div>
                </div>
                <!-- Đóng resp-tabs-container -->
              </div>
            </div>
          </div>
        </div>
      </section>
      <!--grids-sec2-->
      <!-- footer-66 -->
      <div th:replace="~{fragments/footer :: footer}"></div>
    </body>
  </html>
  <script th:src="@{/assets/js/jquery-3.3.1.min.js}"></script>
  <!--/theme-change-->
  <script th:src="@{/assets/js/theme-change.js}"></script>
  <script th:src="@{/assets/js/owl.carousel.js}"></script>
  <script>
    $(document).ready(function () {
      $(".owl-four").owlCarousel({
        loop: true,
        margin: 20,
        nav: false,
        responsiveClass: true,
        autoplay: false,
        autoplayTimeout: 5000,
        autoplaySpeed: 1000,
        autoplayHoverPause: false,
        responsive: {
          0: {
            items: 1,
            nav: false,
          },
          480: {
            items: 2,
            nav: true,
          },
          667: {
            items: 2,
            nav: true,
          },
          1000: {
            items: 2,
            nav: true,
          },
        },
      });
    });
  </script>
  <script>
    $(document).ready(function () {
      $(".owl-two").owlCarousel({
        loop: true,
        margin: 40,
        nav: false,
        responsiveClass: true,
        autoplay: true,
        autoplayTimeout: 5000,
        autoplaySpeed: 1000,
        autoplayHoverPause: false,
        responsive: {
          0: {
            items: 1,
            nav: false,
          },
          480: {
            items: 2,
            nav: true,
          },
          667: {
            items: 2,
            margin: 20,
            nav: true,
          },
          1000: {
            items: 3,
            nav: true,
          },
        },
      });
    });
  </script>
  <!-- script for owlcarousel -->
  <!-- disable body scroll which navbar is in active -->
  <script>
    $(function () {
      $(".navbar-toggler").click(function () {
        $("body").toggleClass("noscroll");
      });
    });
  </script>
  <!-- disable body scroll which navbar is in active -->

  <!--/MENU-JS-->
  <script>
    $(window).on("scroll", function () {
      var scroll = $(window).scrollTop();

      if (scroll >= 80) {
        $("#site-header").addClass("nav-fixed");
      } else {
        $("#site-header").removeClass("nav-fixed");
      }
    });

    //Main navigation Active Class Add Remove
    $(".navbar-toggler").on("click", function () {
      $("header").toggleClass("active");
    });
    $(document).on("ready", function () {
      if ($(window).width() > 991) {
        $("header").removeClass("active");
      }
      $(window).on("resize", function () {
        if ($(window).width() > 991) {
          $("header").removeClass("active");
        }
      });
    });
  </script>
  <script th:src="@{/assets/js/easyResponsiveTabs.js}"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      //Horizontal Tab
      $("#parentHorizontalTab").easyResponsiveTabs({
        type: "default", //Types: default, vertical, accordion
        width: "auto", //auto or any width like 600px
        fit: true, // 100% fit in a container
        tabidentify: "hor_1", // The tab groups identifier
        activate: function (event) {
          // Callback function if tab is switched
          var $tab = $(this);
          var $info = $("#nested-tabInfo");
          var $name = $("span", $info);
          $name.text($tab.text());
          $info.show();
        },
      });
    });
  </script>

  <script th:src="@{/assets/js/bootstrap.min.js}"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Hàm lấy ngày hiện tại theo múi giờ địa phương
    function getCurrentDate() {
      const today = new Date();
      return (
        today.getFullYear() +
        "-" +
        String(today.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(today.getDate()).padStart(2, "0")
      );
    }

    $(document).ready(function () {
      let isShowingAll = false;
      const movieList = $("#movie-list");
      const loadMoreButton = $("#loadMore");

      // Xử lý sự kiện khi click vào nút "More" hoặc "Ẩn bớt"
      loadMoreButton.click(function () {
        if (!isShowingAll) {
          // Đang hiển thị 8 phim đầu, chuyển sang hiển thị tất cả
          loadAllMovies();
        } else {
          // Đang hiển thị tất cả, chuyển về hiển thị 8 phim đầu
          loadInitialMovies();
        }
      });

      // Hàm load tất cả phim
      function loadAllMovies() {
        $.ajax({
          url: "/movie/loadAll",
          type: "GET",
          dataType: "json",
          beforeSend: function () {
            loadMoreButton.prop("disabled", true).text("Loading...");
          },
          success: function (data) {
            if (data && data.length > 0) {
              // Xóa danh sách hiện tại
              movieList.empty();

              // Thêm tất cả phim vào danh sách
              renderMovies(data);

              // Cập nhật trạng thái và nút
              isShowingAll = true;
              loadMoreButton
                .text("Ẩn bớt")
                .removeClass("btn-primary")
                .addClass("btn-secondary");
            }
          },
          error: function () {
            alert("Có lỗi xảy ra khi tải dữ liệu!");
          },
          complete: function () {
            loadMoreButton.prop("disabled", false);
          },
        });
      }

      // Hàm load 8 phim đầu tiên
      function loadInitialMovies() {
        $.ajax({
          url: "/movie/loadMore",
          type: "GET",
          data: {
            page: 0,
            size: 8,
          },
          dataType: "json",
          beforeSend: function () {
            loadMoreButton.prop("disabled", true).text("Loading...");
          },
          success: function (data) {
            if (data && data.length > 0) {
              // Xóa danh sách hiện tại
              movieList.empty();

              // Thêm 8 phim đầu vào danh sách
              renderMovies(data);

              // Cập nhật trạng thái và nút
              isShowingAll = false;
              loadMoreButton.attr("data-page", 1); // Reset page counter
              loadMoreButton
                .text("More")
                .removeClass("btn-secondary")
                .addClass("btn-primary");
            }
          },
          error: function () {
            alert("Có lỗi xảy ra khi tải dữ liệu!");
          },
          complete: function () {
            loadMoreButton.prop("disabled", false);
          },
        });
      }

      // Hàm render danh sách phim
      function renderMovies(movies) {
        if (!movies || movies.length === 0) {
          $("#movie-list").html(
            '<div class="col-12 text-center text-muted py-5">Không tìm thấy phim nào.</div>'
          );
          return;
        }
        // Lấy ngày hiện tại
        const currentDate = getCurrentDate();

        movies.forEach(function (movie) {
          const movieHtml = `
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="box16 mb-0">
                        <figure>
                            <img src="${
                              movie.image
                            }?t=${Date.now()}" class="img-fluid" alt="${
            movie.name
          }">
                        </figure>
                        <div class="box-content">
                            <h3 class="title">${movie.name}</h3>
                            <h4>
                                <span class="post">
                                    <span class="fa fa-clock-o"></span>
                                    ${movie.duration} Phút
                                </span>
                            </h4>
                            <p class="movie-info">
                                <small class="text-muted">${
                                  movie.ratingDisplay || "N/A"
                                }</small><br>
                                <small class="text-muted">${
                                  movie.genreDisplay || "N/A"
                                }</small>
                            </p>
                            <div class="action-buttons">
                                <a href="/schedule/movie/${
                                  movie.id
                                }/date?date=${currentDate}" class="btn btn-success mb-2">Đặt vé</a>
                                <a href="/movie/view/${
                                  movie.id
                                }" class="btn btn-danger">Chi tiết</a>
                            </div>
                        </div>
                    </div>
                </div>`;
          movieList.append(movieHtml);
        });
      }
    });

    // Hàm hiển thị chi tiết phim
    function showDetails(movieId) {
      window.location.href = "/movie/view/" + movieId;
    }

    let currentPage = 0;
    let totalPages = 1;

    function renderMovies(movies) {
      const container = $("#filtered-movie-list");
      container.empty();
      if (!movies || movies.length === 0) {
        container.html(
          '<div class="col-12 text-center text-muted py-5">Không tìm thấy phim nào.</div>'
        );
        return;
      }
      movies.forEach(function (movie) {
        const movieHtml = `
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="box16 mb-0">
                        <figure>
                            <img src="${
                              movie.image
                            }?t=${Date.now()}" class="img-fluid" alt="${
          movie.name
        }">
                        </figure>
                        <div class="box-content">
                            <h3 class="title">${movie.name}</h3>
                            <h4>
                                <span class="post">
                                    <span class="fa fa-clock-o"></span>
                                    ${movie.duration} Phút
                                </span>
                            </h4>
                            <p class="movie-info">
                                <small class="text-muted">${
                                  movie.ratingDisplay || "N/A"
                                }</small><br>
                                <small class="text-muted">${
                                  movie.genreDisplay || "N/A"
                                }</small>
                            </p>
                            <div class="action-buttons">
                                <a href="/schedule/movie/${
                                  movie.id
                                }/date?date=${getCurrentDate()}" class="btn btn-success mb-2">Đặt vé</a>
                                <a href="/movie/view/${
                                  movie.id
                                }" class="btn btn-danger">Chi tiết</a>
                            </div>
                        </div>
                    </div>
                </div>`;
        container.append(movieHtml);
      });
    }

    function renderPagination(totalPages, currentPage) {
      let html = "";
      for (let i = 0; i < totalPages; i++) {
        html += `<button class="btn btn-sm ${
          i === currentPage ? "btn-primary" : "btn-outline-primary"
        } page-btn" data-page="${i}">${i + 1}</button> `;
      }
      $("#pagination").html(html);
      $(".page-btn").click(function () {
        const page = $(this).data("page");
        loadMovies(page);
      });
    }

    function loadMovies(page = 0) {
      const genre = $("#genreSelect").val();
      const sort = $("#sortSelect").val();
      const search = $("#searchInput").val();
      $.ajax({
        url: "/movie/filter",
        type: "GET",
        data: { genre, sort, search, page },
        dataType: "json",
        success: function (data) {
          $("#movie-list").hide();
          $("#filtered-movie-list").show();
          renderMovies(data.movies);
          renderPagination(data.totalPages, data.currentPage);
          totalPages = data.totalPages;
          currentPage = data.currentPage;
        },
        error: function () {
          alert("Có lỗi xảy ra khi lọc phim!");
        },
      });
    }

    $("#filterBtn").click(function () {
      loadMovies(0);
    });

    $(document).ready(function () {
      // Load genres from API and render options
      $.ajax({
        url: "/movie/genres",
        type: "GET",
        success: function (genres) {
          const genreSelect = $("#genreSelect");
          genreSelect.empty();
          genreSelect.append('<option value="">Tất cả thể loại</option>');
          genres.forEach(function (genre) {
            if (genre)
              genreSelect.append(`<option value="${genre}">${genre}</option>`);
          });
        },
      });
      loadMovies(0);
    });

    //
    // function showDetails(movieId) {
    //     console.log("Xem chi tiết phim ID:", movieId);
    //     // Thêm code xử lý hiển thị chi tiết
    // }
  </script>

  <style>
    .movie-info {
      margin: 10px 0;
      min-height: 40px;
    }
    .movie-info small {
      display: block;
      margin-bottom: 2px;
      font-size: 0.85em;
    }
  </style>
</html>
