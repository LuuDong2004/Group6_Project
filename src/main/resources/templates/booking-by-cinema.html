<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Đặt vé theo rạp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/assets/css/booking-cinema-custom.css" rel="stylesheet">
    <style>
        body { background: #f7f7fa; }
        .step-section { display: none; }
        .step-section.active { display: block; }
        .cinema-card, .movie-card, .date-tab, .showtime-btn { border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .cinema-card.selected, .date-tab.selected { background: #fce4ec; border: 2px solid #e91e63; color: #e91e63; }
        .date-tab { cursor: pointer; padding: 12px 18px; margin: 0 6px 12px 0; display: inline-block; background: #fff; border: 1px solid #eee; font-weight: 500; }
        .date-tab.selected { background: #e91e63; color: #fff; }
        .showtime-btn { margin: 0 6px 6px 0; border: 1px solid #e91e63; color: #e91e63; background: #fff; }
        .showtime-btn:hover { background: #e91e63; color: #fff; }
        .movie-poster { width: 100px; height: 140px; object-fit: cover; border-radius: 12px; }
        .movie-info { margin-left: 20px; }
        .step-title { color: #e91e63; font-weight: 700; margin-bottom: 18px; }
        .step-indicator { margin-bottom: 24px; }
        .step-indicator span { display: inline-block; width: 32px; height: 32px; line-height: 32px; border-radius: 50%; background: #e91e63; color: #fff; text-align: center; margin-right: 8px; font-weight: bold; }
        @media (max-width: 768px) {
            .movie-info { margin-left: 0; margin-top: 12px; }
            .movie-poster { width: 80px; height: 110px; }
        }
    </style>
</head>
<body>
<!-- Header -->
<div th:replace="fragments/header :: header"></div>
<div class="container py-4">
    <div class="step-indicator">
        <span id="step1-ind">1</span> Chuỗi rạp
        <span id="step2-ind">2</span> Rạp
        <span id="step3-ind">3</span> Ngày
        <span id="step4-ind">4</span> Phim & Suất chiếu
    </div>
    <!-- Step 1: Chọn chuỗi rạp -->
    <div id="step1" class="step-section active">
        <div class="step-title">Chọn chuỗi rạp</div>
        <div class="row" id="chain-list"></div>
    </div>
    <!-- Step 2: Chọn rạp -->
    <div id="step2" class="step-section">
        <div class="step-title">Chọn rạp</div>
        <button class="btn btn-link mb-3" onclick="gotoStep(1)">&lt; Quay lại chuỗi rạp</button>
        <div class="row" id="branch-list"></div>
    </div>
    <!-- Step 3: Chọn ngày -->
    <div id="step3" class="step-section">
        <div class="step-title">Chọn ngày</div>
        <button class="btn btn-link mb-3" onclick="gotoStep(2)">&lt; Quay lại rạp</button>
        <div id="date-list"></div>
    </div>
    <!-- Step 4: Chọn phim & suất chiếu -->
    <div id="step4" class="step-section">
        <div class="step-title">Chọn phim & suất chiếu</div>
        <button class="btn btn-link mb-3" onclick="gotoStep(3)">&lt; Quay lại ngày</button>
        <div id="movie-list"></div>
    </div>
</div>
<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let selectedChain = null, selectedBranch = null, selectedDate = null;
function gotoStep(step) {
    document.querySelectorAll('.step-section').forEach((el, idx) => el.classList.toggle('active', idx === step-1));
    document.querySelectorAll('.step-indicator span').forEach((el, idx) => el.style.background = (idx === step-1) ? '#e91e63' : '#ccc');
}
// Step 1: Load chains
fetch('/api/cinema-chains').then(r=>r.json()).then(data=>{
    const list = document.getElementById('chain-list');
    list.innerHTML = '';
    data.forEach(chain=>{
        const card = document.createElement('div');
        card.className = 'col-md-3 mb-3';
        card.innerHTML = `<div class='card cinema-card text-center p-3' onclick='selectChain(${chain.id}, "${chain.name}")'><h5>${chain.name}</h5></div>`;
        list.appendChild(card);
    });
});
function selectChain(id, name) {
    selectedChain = {id, name};
    gotoStep(2);
    fetch(`/api/cinema-chains/${id}/branches`).then(r=>r.json()).then(data=>{
        const list = document.getElementById('branch-list');
        list.innerHTML = '';
        data.forEach(branch=>{
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-3';
            card.innerHTML = `<div class='card cinema-card p-3' onclick='selectBranch(${branch.id}, "${branch.name}")'><h5>${branch.name}</h5><div>${branch.address||''}</div></div>`;
            list.appendChild(card);
        });
    });
}
function selectBranch(id, name) {
    selectedBranch = {id, name};
    gotoStep(3);
    fetch(`/booking/branches/${id}/available-dates`).then(r=>r.json()).then(dates=>{
        const list = document.getElementById('date-list');
        list.innerHTML = '';
        if (!dates.length) { list.innerHTML = '<div class="alert alert-warning">Không có lịch chiếu</div>'; return; }
        dates.forEach((date,i)=>{
            const tab = document.createElement('span');
            tab.className = 'date-tab'+(i===0?' selected':'');
            tab.textContent = date;
            tab.onclick = ()=>selectDate(date,tab);
            list.appendChild(tab);
        });
        selectDate(dates[0], list.querySelector('.date-tab'));
    });
}
function selectDate(date, tab) {
    selectedDate = date;
    document.querySelectorAll('.date-tab').forEach(t=>t.classList.remove('selected'));
    tab.classList.add('selected');
    gotoStep(4);
    fetch(`/booking/branches/${selectedBranch.id}/showtimes?date=${date}`).then(r=>r.json()).then(data=>{
        const list = document.getElementById('movie-list');
        list.innerHTML = '';
        if (!data.length) { list.innerHTML = '<div class="alert alert-warning">Không có lịch chiếu cho ngày này.</div>'; return; }
        data.forEach(movie=>{
            let showtimesHtml = '';
            if (movie.schedules && movie.schedules.length) {
                showtimesHtml = movie.schedules.map(sch=>
                    `<a href='/seat/${movie.id}/${sch.id}/${sch.roomId}' class='btn showtime-btn'>${sch.screeningDate} ${sch.startTime}</a>`
                ).join('');
            } else {
                showtimesHtml = '<span class="text-muted">Không có lịch chiếu</span>';
            }
            list.innerHTML += `<div class='card movie-card mb-3 p-3 d-flex flex-row align-items-center'>
                <img src='${movie.poster || '/static/assets/images/default-movie.png'}' class='movie-poster me-3'>
                <div class='movie-info'>
                    <h5>${movie.title||movie.name}</h5>
                    <div>${showtimesHtml}</div>
                </div>
            </div>`;
        });
    });
}
</script>
</body>
</html>